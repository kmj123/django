<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css"> 
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>관리자 | 사용자관리</title>
  <style>
    *{margin : 0; padding : 0;  box-sizing : border-box;}
    body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        padding: 30px 30px 30px 45px;
    }
        .banner {
          width: 1000px;
          height: 70px;
          background: rgba(255, 255, 255, 0.95);
          border-radius: 20px;
          display: flex;
          align-items: center;
          margin-top : -10px;
          justify-content: space-between;
          padding: 0 25px;
          margin-bottom: 15px;
      }
        .banner h2{ 
            font-size : 30px; 
            color : #7E6EB0;
            align-items : center; 
            margin-left: 15px;
        }
        .banner-center {
            display: flex;
            align-items: center;
        }
        .banner-right {
            display: flex;
            align-items: center;
        }
        .table{display : flex;
            margin-top : 15px;}
        .menu {
            display: flex;
            align-items: center;
        }
        .menu ul {
            display: flex;
            list-style: none;
            margin: 0;
            padding: 0;
            gap: 10px;
        }
        .menu li{
            display : flex;
            text-align : center;
            align-items : center;
            justify-content: center;
            padding: 0 15px;
            font-weight : 500;
            width : 115px;
            height : 40px;
            border-radius : 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            color : #764ba2;
            border : 2px solid  #764ba2;
        }
        .menu li a{color : #764ba2;}
        .menu .board{
            background : linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color : rgba(255, 255, 255, 0.95);
            border : none;
        }
        .menu li.board a {
          color: rgba(255, 255, 255, 0.95); 
        }

        .menu li {
            text-decoration: none;
        }
        .menu li a {
            text-decoration: none;
            color: #764ba2; 
          }

        
        a{text-decoration : none;}
        .home {
            all: unset;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            color: #7E6EB0;
            padding: 10px 15px;
            border-radius: 10px;
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .home:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .home i {
            font-size: 16px;
            display: flex;
            align-items: center;
        }
        .content{
            width : 100%;
            height : 800px;
            background : white;
            border-radius : 25px;
            background : rgba(255, 255, 255, 0.95);
        }
        .dash-top{height : 80px; width : 860px; text-align : center;
                margin : 30px 40px 0 70px;font-size : 16px;}
        .dash-top hr{ margin-top : 27px;}
        .box{display : flex;}

    /* 메인 콘텐츠 영역 */
    .content {
      flex: 1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 25px;
      padding: 30px 40px;
      margin-top : 5px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      min-height: 800px;
    }

    /* 페이지 제목 */
    .page-header {
      margin-bottom: 30px;
    }

    .page-header h2 {
      text-align : center;
      font-size: 24px;
      color: #333;
      margin-bottom: 15px;
    }

    .page-header hr {
      border: none;
      height: 1px;
      background: #e0e0e0;
    }

    /* 통계 박스들 */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin: 30px 0;
    }

    .stats-box {
      background: white;
      border-radius: 15px;
      padding: 30px;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
      transition: transform 0.3s ease;
    }

    .stats-box:hover {
      transform: translateY(-5px);
    }

    .stats-box .number {
      font-size: 36px;
      font-weight: 700;
      color: #667eea;
      margin-bottom: 10px;
    }

    .stats-box .label {
      font-size: 16px;
      color: #666;
      font-weight: 500;
    }

    /* 필터 영역 */
    .filter-section {
      background: white;
      border-radius: 15px;
      padding: 20px;
      margin: 25px 0;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .filter-section select {
      padding: 10px 15px 10px 0;
      text-align : center;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      background: white;
      font-size: 14px;
      outline: none;
      transition: border-color 0.3s ease;
    }

    .filter-section select:focus {
      border-color: #667eea;
    }

    .search-input {
      flex: 1;
      max-width: 400px;
      padding: 10px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      outline: none;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .search-input:focus {
      border-color: #667eea;
    }

    .search-btn {
      padding: 10px 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: transform 0.2s ease;
    }

    .search-btn:hover {
      transform: translateY(-2px);
    }

    /* 테이블 스타일 */
    .table-container {
      background: white;
      border-radius: 15px;
      overflow: hidden;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
      margin: 20px 0;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }

    thead {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    th {
      padding: 15px;
      color: white;
      font-weight: 600;
      text-align: center;
    }

    td {
      padding: 15px;
      text-align: center;
      border-bottom: 1px solid #f0f0f0;
    }

    tbody tr {
      transition: background-color 0.2s ease;
    }

    tbody tr:hover {
      background-color: #f8f9ff;
    }

    tbody tr:last-child td {
      border-bottom: none;
    }

    /* 체크박스 스타일 */
    input[type="checkbox"] {
      transform: scale(1.3);
      cursor: pointer;
    }

    /* 하단 바 */
    .bottom-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 30px;
      padding: 20px;
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
    }

    .bottom-bar > div {
      flex: 1;
    }

    .bottom-bar > div:nth-child(2) {
      display: flex;
      justify-content: center;
    }

    .bottom-bar > div:nth-child(3) {
      display: flex;
      justify-content: flex-end;
    }

    /* 페이지네이션 */
    .pagination {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .pagination a,
    .pagination strong {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 35px;
      height: 35px;
      text-decoration: none;
      color: #666;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .pagination strong {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }

    .pagination a:hover {
      background: #f0f0f0;
    }

    .pagination img {
      width: 16px;
      height: 16px;
    }

    /* 액션 버튼들 */
    .action-buttons {
      display: flex;
      gap: 10px;
    }

    .action-btn {
      padding: 10px 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.3s ease;
    }
    
    .btn-delete {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-delete:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: translateY(-2px);
    }

    .btn-suspend {
      background:linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-suspend:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: translateY(-2px);
    }

    .btn-release {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-release:hover {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      transform: translateY(-2px);
    }

    /* 상태 라벨 */
    .status-suspended {
      color: #ff4757;
      font-weight: 600;
    }

    .status-report {
      color:rgb(255, 145, 71);
      font-weight: 600;
    }

    .status-active {
      color: #2ed573;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- 상단 배너 -->
    <div class="banner">
      <a href = "{% url 'home:main' %}"><h2>PO-PIN</h2></a>
      <div class = "menu">
        <ul>
          <li><a href="{% url 'adpage:main' %}">메인</a></li>
          <li><a href="{% url 'adpage:notice' %}">공지사항</a></li>
          <li><a href="{% url 'adpage:post' %}">게시글 관리</a></li>
          <li class="board"><a href="{% url 'adpage:user' %}">사용자 관리</a></li>
        </ul>
            </div>
            <div class="banner-right">
                <a href="{% url 'home:main' %}" class="home">
                    <i class="fi fi-rr-home"></i>홈으로
                </a>
            </div>

    </div>

    <div class="main-layout">

      <!-- 메인 콘텐츠 -->
      <main class="content">
        <!-- 페이지 헤더 -->
        <div class="page-header">
          <h2>사용자 관리</h2>
          <hr>
        </div>

        <!-- 통계 박스들 -->
        <div class="stats-container">
          <div class="stats-box">
            <div class="number">{{total_users}}</div>
            <div class="label">전체 사용자</div>
          </div>
          <div class="stats-box">
            <div class="number">{{active_users}}</div>
            <div class="label">활성 사용자</div>
          </div>
          <div class="stats-box">
            <div class="number">{{block_users}}</div>
            <div class="label">정지된 사용자</div>
          </div>
        </div>

        <!-- 필터 섹션 -->
        <div class="filter-section">
          <select>
            <option value="">유저 상태</option>
            <option value="status-active">정상</option>
            <option value="status-report">신고</option>
            <option value="status-suspended">정지</option>
          </select>
          <input type="text" class="search-input" placeholder="사용자 ID 또는 이메일로 검색">
          <button class="search-btn">검색</button>
        </div>

        <!-- 사용자 테이블 -->
        <div class="table-container">
          <table>
            <colgroup>
              <col style="width: 5%">
              <col style="width: 15%">
              <col style="width: 15%">
              <col style="width: 35%">
              <col style="width: 12%">
              <col style="width: 18%">
            </colgroup>
            <thead>
              <tr>
                <th><input type="checkbox" id="selectAll"></th>
                <th>사용자 ID</th>
                <th>닉네임</th>
                <th>이메일</th>
                <th>신고 횟수</th>
                <th>계정 상태</th>
              </tr>
            </thead>
            <tbody>
              {%for user in users%}
                <tr>
                  <td><input type="checkbox" class="user-checkbox" value="{{ user.user_id }}"></td>
                  <td>{{user.user_id}}</td>
                  <td>{{user.nickname}}</td>
                  <td>{{user.email}}</td>
                  <td>{{user.report_count}}</td>
                  {%if user.state == 1%}
                    <td><span class="status-active">정상</span></td>
                  {%elif user.state == 2%}
                    <td><span class="status-report">신고</span></td>
                  {%elif user.state == 3%}
                    <td><span class="status-suspended">계정 정지</span></td>
                  {%endif%}
              </tr>
              {%endfor%}
            </tbody>
          </table>
        </div>

        <!-- 하단 바 (페이지네이션 + 액션 버튼) -->
        <div class="bottom-bar">
          <div></div> <!-- 왼쪽 공간 -->
          <div class="pagination">
            <a href="#" title="첫 페이지">«</a>
            <a href="#" title="이전 페이지">‹</a>
            <strong>1</strong>
            <a href="#">2</a>
            <a href="#">3</a>
            <a href="#">4</a>
            <a href="#">5</a>
            <a href="#" title="다음 페이지">›</a>
            <a href="#" title="마지막 페이지">»</a>
          </div>
          <div class="action-buttons">
            <button class="action-btn btn-delete">계정 삭제</button>
            <button class="action-btn btn-suspend">계정 정지</button>
            <button class="action-btn btn-release">정지 해제</button>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
          cookie = cookie.trim();
          if (cookie.substring(0, name.length + 1) === (name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
          }
        }
      }
      return cookieValue;
    }
    // 전체 선택 체크박스 기능
    document.getElementById('selectAll').addEventListener('change', function() {
      const checkboxes = document.querySelectorAll('.user-checkbox');
      checkboxes.forEach(checkbox => {
        checkbox.checked = this.checked;
      });
    });

    // 개별 체크박스 상태에 따른 전체 선택 체크박스 업데이트
    document.querySelectorAll('.user-checkbox').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        const allCheckboxes = document.querySelectorAll('.user-checkbox');
        const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
        const selectAllCheckbox = document.getElementById('selectAll');
        
        selectAllCheckbox.checked = allCheckboxes.length === checkedBoxes.length;
        selectAllCheckbox.indeterminate = checkedBoxes.length > 0 && checkedBoxes.length < allCheckboxes.length;
      });
    });

    // 검색 기능
    document.querySelector('.search-btn').addEventListener('click', function() {
      const searchValue = document.querySelector('.search-input').value.trim();
      if (searchValue) {
        console.log('검색어:', searchValue);
      }
    });


    // 엔터키로 검색
    document.querySelector('.search-input').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        document.querySelector('.search-btn').click();
      }
    });

    // 선택된 사용자의 상태(span 클래스명) 얻기 함수
    function getSelectedUserStates() {
      const selectedRows = Array.from(document.querySelectorAll('.user-checkbox:checked'))
        .map(checkbox => checkbox.closest('tr'));

      return selectedRows.map(row => {
        const statusSpan = row.querySelector('td:nth-child(6) span');
        return statusSpan ? statusSpan.className : '';
      });
    }

    // 계정 삭제 (상태 검사 없음)
    document.querySelector('.btn-delete').addEventListener('click', function () {
      if (!confirm("정말 삭제하시겠습니까?")) return;

      const checkedBoxes = document.querySelectorAll('.user-checkbox:checked');
      const ids = Array.from(checkedBoxes).map(cb => cb.value);

      if (ids.length === 0) {
        alert("선택된 유저가 없습니다.");
        return;
      }

      fetch('/adpage/user/delete/', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': getCookie('csrftoken'),
        },
        body: JSON.stringify({ ids: ids })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          alert("삭제 완료!");
          location.reload();  // 삭제 후 새로고침
        } else {
          alert("삭제 중 오류 발생: " + (data.error || "알 수 없는 오류"));
        }
      })
      .catch(error => {
        console.error("Error:", error);
        alert("서버 요청 중 오류가 발생했습니다.");
      });
    });

    // 계정 정지 (정지 상태인 사용자가 선택되면 안 됨)
    document.querySelector('.btn-suspend').addEventListener('click', function() {
      const selected = document.querySelectorAll('.user-checkbox:checked');
      if (selected.length === 0) {
        alert('정지할 사용자를 선택해주세요.');
        return;
      }
      const states = getSelectedUserStates();
      if (states.some(state => state.includes('status-suspended'))) {
        alert('이미 정지된 사용자는 다시 정지할 수 없습니다.');
        return;
      }
      if (confirm(`선택한 ${selected.length}명의 계정을 정지하시겠습니까?`)) {
        console.log('계정 정지 처리');
        const ids = Array.from(selected).map(checkbox =>
          checkbox.closest('tr').children[1].textContent.trim()
        );
        fetch('/adpage/user/block/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("수정 완료!");
            location.reload();  // 삭제 후 새로고침
          } else {
            alert("수정 중 오류 발생: " + (data.error || "알 수 없는 오류"));
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("서버 요청 중 오류가 발생했습니다.");
        });
      }
    });

    // 정지 해제 (정지 상태가 아닌 사용자가 선택되면 안 됨)
    document.querySelector('.btn-release').addEventListener('click', function() {
      const selected = document.querySelectorAll('.user-checkbox:checked');
      if (selected.length === 0) {
        alert('정지 해제할 사용자를 선택해주세요.');
        return;
      }
      const states = getSelectedUserStates();
      if (states.some(state => !state.includes('status-suspended'))) {
        alert('정지 상태가 아닌 사용자는 정지 해제할 수 없습니다.');
        return;
      }
      if (confirm(`선택한 ${selected.length}명의 계정 정지를 해제하시겠습니까?`)) {
        console.log('정지 해제 처리');
        const ids = Array.from(selected).map(checkbox =>
          checkbox.closest('tr').children[1].textContent.trim()
        );
        fetch('/adpage/user/block/', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken'),
          },
          body: JSON.stringify({ ids: ids })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            alert("수정 완료!");
            location.reload();  // 삭제 후 새로고침
          } else {
            alert("수정 중 오류 발생: " + (data.error || "알 수 없는 오류"));
          }
        })
        .catch(error => {
          console.error("Error:", error);
          alert("서버 요청 중 오류가 발생했습니다.");
        });
      }
    });



    // 페이지네이션
  let currentPage = 1;
  const itemsPerPage = 4;
  let filteredCards = [];

  function showPage(pageNumber) {
    currentPage = pageNumber;
    hideAllCards();
    showCurrentPageCards();
    updatePageButtons();
  }

  function hideAllCards() {
    filteredCards.forEach(card => card.style.display = "none");
  }

  function showCurrentPageCards() {
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const cardsToShow = filteredCards.slice(startIndex, endIndex);
    cardsToShow.forEach(card => card.style.display = "");
  }

  function updatePageButtons() {
  const pagination = document.querySelector(".pagination");
  pagination.innerHTML = "";

  const totalPages = Math.ceil(filteredCards.length / itemsPerPage);

  // << 첫 페이지
  const firstBtn = createButton("«", () => showPage(1));
  const prevBtn = createButton("‹", () => {
    if (currentPage > 1) showPage(currentPage - 1);
  });
  pagination.appendChild(firstBtn);
  pagination.appendChild(prevBtn);

  // 고정된 최대 페이지 수
  const maxVisiblePages = 5;

  let startPage, endPage;
  if (totalPages <= maxVisiblePages) {
    startPage = 1;
    endPage = totalPages;
  } else {
    const half = Math.floor(maxVisiblePages / 2);
    if (currentPage <= half) {
      startPage = 1;
      endPage = maxVisiblePages;
    } else if (currentPage + half >= totalPages) {
      startPage = totalPages - maxVisiblePages + 1;
      endPage = totalPages;
    } else {
      startPage = currentPage - half;
      endPage = currentPage + half;
      if (maxVisiblePages % 2 === 0) endPage--; // 짝수일 경우 조정
    }
  }

  for (let i = startPage; i <= endPage; i++) {
    if (i === currentPage) {
      const strong = document.createElement("strong");
      strong.textContent = i;
      pagination.appendChild(strong);
    } else {
      const btn = createButton(i, () => showPage(i));
      pagination.appendChild(btn);
    }
  }

  const nextBtn = createButton("›", () => {
    if (currentPage < totalPages) showPage(currentPage + 1);
  });
  const lastBtn = createButton("»", () => showPage(totalPages));
  pagination.appendChild(nextBtn);
  pagination.appendChild(lastBtn);
}


  function createButton(label, clickHandler) {
    const a = document.createElement("a");
    a.href = "#";
    a.textContent = label;
    a.style.margin = "0 5px";
    a.addEventListener("click", function (e) {
      e.preventDefault();
      clickHandler();
    });
    return a;
  }

  document.addEventListener("DOMContentLoaded", () => {
    filteredCards = Array.from(document.querySelectorAll("tbody tr"));
    showPage(1);
  });

  function applyFilterAndSearch() {
  const selectedStatus = document.querySelector(".filter-section select").value;
  const searchKeyword = document.querySelector(".search-input").value.trim().toLowerCase();

  const allRows = Array.from(document.querySelectorAll("tbody tr"));

  // 일단 모든 row 숨기기
  allRows.forEach(row => row.style.display = "none");

  // 조건에 맞는 row만 filteredCards에 담고 다시 보이게
  filteredCards = allRows.filter(row => {
    const statusSpan = row.querySelector("td:nth-child(6) span");
    const userId = row.querySelector("td:nth-child(2)")?.textContent.toLowerCase() || "";
    const email = row.querySelector("td:nth-child(4)")?.textContent.toLowerCase() || "";

    const statusMatch = !selectedStatus || statusSpan.classList.contains(selectedStatus);
    const keywordMatch = !searchKeyword || userId.includes(searchKeyword) || email.includes(searchKeyword);

    return statusMatch && keywordMatch;
  });

  // 필터된 row만 보이게 하기 위해 pagination 호출
  showPage(1);
}


  // 검색 버튼 클릭
  document.querySelector(".search-btn").addEventListener("click", applyFilterAndSearch);

  // Enter 키 검색
  document.querySelector(".search-input").addEventListener("keypress", function(e) {
    if (e.key === "Enter") applyFilterAndSearch();
  });

  // 필터 select 변경 시 자동 적용
  document.querySelector(".filter-section select").addEventListener("change", applyFilterAndSearch);

  </script>
</body>
</html>