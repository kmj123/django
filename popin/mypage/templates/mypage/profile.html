{% extends 'header_login.html'%}
{% load static %}
<!--상단 헤더-->
{%block content%}

<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="csrf-token" content="{{ csrf_token}}">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/static/css/mypage.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <title>{%block title%}마이페이지{%endblock%}</title>
    </head>
    <style>
        .modal{
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content{
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            background-color: #ffff;
            FONT-WEIGHT: 200;
            /* margin: 20px auto; */
            padding: 65px;
            max-height: 100%;
            overflow-y: auto;
        }

        .close {
        position: block;
        top: 10px;
        right: 16px;
        font-size: 28px;
        cursor: pointer;
        }
        /*검색css*/

        .search-container {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        }

        .search-box {
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        width: 100%;
        transition: all 0.3s ease;
        }

        .search-box:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        }

        .filter-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        }

        .filter-btn.active, .filter-btn:hover {
        background: #667eea;
        color: white;
        }

        .selected-count {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
        }

        .selected-members {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        }

        .selected-members h3 {
        margin-bottom: 15px;
        color: #333;
        }

        .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        }

        .selected-item {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding:15px;
        border-radius: 15px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        }

        .remove-btn {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        color: white;
        font-size: 12px;
        }

        .search-noticeBox {
        text-align: center;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border: 2px dashed #667eea;
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .search-notice .icon {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
        }

        .search-notice .main-text {
        color: #667eea;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        }

        .search-notice .sub-text {
        font-size: 14px;
        color: #999;
        }

        .groups-container {
            display: grid;
            gap: 20px;
        }

        .group-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .group-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        }

        .group-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        }

        .group-type {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        }

        .boy-group {
        background: #e3f2fd;
        color: #1976d2;
        }

        .girl-group {
        background: #fce4ec;
        color: #c2185b;
        }

        .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        }

        .member-toggle {
        padding: 8px 12px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 12px;
        font-weight: 500;
        }

        .member-toggle:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        }

        .member-toggle.selected {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .member-toggle.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        }

        .selection-limit-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 14px;
        }
        .btn {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        }

        .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        margin-top: 1.5rem;
        }

        .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        }

        #toast{
            visibility: hidden;
            min-width: 304px;
            margin-left:-125px;
            background-color:rgba(120,120,120 ,0.8);
            color:#fff;
            text-align:center;
            border-radius: 6px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 50%;
            font-size:12px;
            opacity: 0;
            trasition: opacity 0.5s, bottom: 0.5s;
            padding:20px;
        }

        #toast.show{
            visibility:visible;
            opacity: 1;
            bottom: 50%;
        }

    </style>

    <script>
        // 프로필 수정 모달창 스크립트
        document.addEventListener('DOMContentLoaded', function () {
            const modalOpenButton = document.getElementById('profile_modal');
            const modalSaveButton = document.getElementById('favorite-btnSave');
            const modalCloseButton = document.getElementById('favorite-btnClose');
            const modal = document.getElementById('modalContainer');

            // 모달창 오픈
            modalOpenButton.addEventListener('click', () => {
                modal.classList.remove('hidden');
            });

            // 모달창 저장
            modalSaveButton.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            // 모달창 닫기
            modalCloseButton.addEventListener('click',() => {
                modal.classList.add('hidden');
            });
        });
        //모달창스크립트

        // 전체 카테고리
        function showTab(tabName) {
            const contents = document.querySelectorAll('.tab-content');
            const tabs = document.querySelectorAll('.tab');
            // 모든 탭 콘텐츠 숨기기
            contents.forEach(content => {
                content.classList.remove('active');
            });

            // 모든 탭 버튼 비활성화
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // 선택된 탭 콘텐츠 보이기
            document.getElementById(tabName).classList.add('active');

            // 선택된 탭 버튼 활성화
            event.target.classList.add('active');
        }

        // 교환거래 카테고리
        function showTransactionTab(type) {
            const transactionTabs = document.querySelectorAll('.transaction-tab');
            const transactionContents = document.querySelectorAll('.transaction-content');
            const sellingList = document.getElementById('selling-list');
            const buyingList = document.getElementById('buying-list');
            const exchangeList = document.getElementById('exchange-list');
            // 교환거래 탭 버튼들 비활성화
            transactionTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // 교환거래 콘텐츠들 숨기기
            transactionContents.forEach(content => {
                content.style.display = 'none';
            });

            // 선택된 탭 활성화
            event.target.classList.add('active');
            
            // 선택된 콘텐츠 보이기
            if (type === 'selling') {
                sellingList.style.display = 'block';
            } else if(type==='buying'){
                buyingList.style.display = 'block';
            } else if(type==='exchange'){
                exchangeList.style.display='block';
            }
        }

        // 후기 카테고리
        function showReviewTab(type) {
            const reviewTabs = document.querySelectorAll('.review-tab');
            const reviewContents = document.querySelectorAll('.review-content');
            // 후기 탭 버튼들 비활성화
            reviewTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // 후기 콘텐츠들 숨기기
            reviewContents.forEach(content => {
                content.style.display = 'none';
            });

            // 선택된 탭 활성화
            event.target.classList.add('active');
            
            // 선택된 콘텐츠 보이기
            if (type === 'received') {
                document.getElementById('received-reviews').style.display = 'block';
            } else {
                document.getElementById('written-reviews').style.display = 'block';
            }
        }

        // 커뮤니티 카테고리 
        function showCommunityTab(type){
            const communityTabs = document.querySelectorAll('.community-tab');
            const communityContents = document.querySelectorAll('.community-content');
            const WithU = document.getElementById('WithU');
            const Sharing = document.getElementById('Sharing');
            const Insteadbuy = document.getElementById('Insteadbuy');
            const shareNow = document.getElementById('shareNow');

            communityTabs.forEach(tab=>{
                tab.classList.remove('active');
            });

            communityContents.forEach(content=>{
                content.style.display="none";
            })

            event.target.classList.add('active');

            if (type === "WithU"){
                WithU.style.display="block";
            } else if(type === "Sharing"){
                Sharing.style.display="block";
            } else if(type === "Insteadbuy"){
                Insteadbuy.style.display="block";
            } else if(type === "shareNow"){
                shareNow.style.display="block";
            }
        }

        // 블랙리스트 카테고리
        function showBlockedTab(type){
            const blockedTabs = document.querySelectorAll('.blocked-tab');
            const blockedContents = document.querySelectorAll('.blocked-content')
            const blockeduser = document.getElementById('blocked-user');
            const blockedpost = document.getElementById('blocked-post');

            // 블랙리스트 탭 버튼들 비활성화
            blockedTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // 블랙리스트 콘텐츠들 숨기기
            blockedContents.forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');

            // 선택된 콘텐츠 보이기
            if (type === 'blocked-user') {
                blockeduser.style.display = 'block';
            } else {
                blockedpost.style.display = 'block';
            }
        }
        
        // 앨범 -> 
        function showPhotoCards(albumId) {
            const albumData = photocardData[albumId];
            if (!albumData) return;

            // 앨범 목록 숨기기
            document.getElementById('album-list').style.display = 'none';
            
            // 포토카드 목록 보이기
            document.getElementById('photocard-list').style.display = 'block';
            
            // 뒤로가기 버튼 보이기
            document.querySelector('.back-btn').style.display = 'inline-block';
            
            // 현재 앨범 제목 설정
            document.getElementById('current-album-title').textContent = albumData.title;
            
            // 포토카드 그리드 생성
            const photocardGrid = document.querySelector('.photocard-grid');
            photocardGrid.innerHTML = '';
            
            albumData.cards.forEach(card => {
                const photocardElement = document.createElement('div');
                photocardElement.className = 'photocard';
                photocardElement.innerHTML = `
                    <div class="photocard-img">
                        <img src="${card.img}" alt="${card.member}">
                    </div>
                    <h5>${card.member}</h5>
                    <p>${card.type}</p>
                    `;
                photocardGrid.appendChild(photocardElement);
            });
        }

        function showAlbumList() {
            // 포토카드 목록 숨기기
            document.getElementById('photocard-list').style.display = 'none';
            
            // 앨범 목록 보이기
            document.getElementById('album-list').style.display = 'grid';
            
            // 뒤로가기 버튼 숨기기
            document.querySelector('.back-btn').style.display = 'none';
        }

        // 변경하기 버튼 클릭 이벤트
        document.querySelectorAll('.change-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                alert('변경 기능이 실행됩니다.');
            });
        });

        // toast 기능구현
        function showToast(message, duration = 2000) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";

            // 일정 시간 후 토스트 숨기기
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, duration);   
        }

        
        // 차단해제 버튼 클릭 이벤트
        document.querySelectorAll('.unblock-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if(confirm('정말 차단을 해제하시겠습니까?')) {
                    this.parentElement.remove();
                }
            });
        });
    </script>

    <body>
    <!--toast용-->
    <div id="toast" class="toast"></div> 

    <!--프로필-->
    <main class="main">
        <form>
            <div class="profile-card">
                <div class="profile-header">
                    <div class="polaroid" id="profile_modal">
                        <div class="polaroid-image">
                            <!--클릭시 프로필변경페이지 이동-->
                            {%if profile_image%}
                            <img src='/media/{{profile_image}}/' alt='{{profile_image}}'>
                            {%else%}
                            <img src='/static/images/no-image.png/' alt='(이미지 없음)' style="object-fit: none;">
                            {%endif%}
                        </div>
                        
                        <!-- 프로필 수정 모달창 오픈 -->
                        <button id="favorite-btn" type="button">

                            {%if group_logo %}
                                <img src="/media/{{group_logo}}/" alt="group_logo">
                            {%else%}
                                <img src="(로고없음)" alt="(로고없음)"> 
                            {%endif%}
                        </button>
                    </div>
                    <div class="profile-info">
                        <h1>{{nickname}}</h1>
                        <h3>"{{introduction}}"</h3>
                        <br>
                        
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-number">{{selling_photocards}}</div>
                                <div>보유 포카</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">{{completed}}</div>
                                <div>교환 완료</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">{{manners_score}}</div>
                                <div>평점</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <!--//프로필-->

        <!--프로필 수정 모달창 구현-->
        <form action="/mypage/update_profile/" method="post" name="profileFrm" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="modalContainer" class="hidden">
                <div id="modalContent">
                    <div class="profileTop">
                        <button id="favorite-btnClose" type="button">
                            <img src="/static/images/mypage/cancelicon.png" style="width: 40px; height: 40px;">
                        </button>
                        <h1>프로필 수정</h1>
                    </div>
                    <div class="profileContent">
                        <label for="profile_image">프로필 이미지</label>
                        <div class="profile_img_container">
                            <div class="profile_img_wrapper">
                                <div class="previous_container" id="previous_container" style="cursor:pointer;">
                                    <img id="previousImage" src="/media/{{ profile_image }}/" class="profile_image" alt="프로필 이미지">
                                </div>
                                <input type="file" id="profile-img-input" name="profile_image" class="fileType" accept="image/*" style="display:none;">
                            </div>
                            <div class="preview-container" id="previewContainer" style="display:none;">
                                <img id="previewImage" class="preview-image" alt="미리보기">
                            </div>
                        </div>
                        <div class="myinfo">
                            <div class="myinfo-profile">
                                <label for="nickname">닉네임</label>
                                <input type="text" id="nickname" name="nickname" value="{{ nickname }}">
                            </div>
                            <div class="myinfo-profile">
                                <label for="mybias">마이 아티스트</label>
                                {% for group,member in bias_pairs %}
                                    {%if forloop%}
                                    <div class="mybias_input">
                                    <input type="text" id="mybias" name="mybias" value="{{ group.name }} - {{member.name}}" readonly style="cursor: pointer;">
                                    {%endif%}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="myinfo-profile">
                                <label for="myself">자기소개</label>
                                <input type="text" id="myself" name="introduction" value="{{ introduction }}">
                            </div>
                            <div class="myinfo-profile">
                                <button id="favorite-btnSave" type="submit">변경사항 저장</button>
                            </div>

                            <!--아티스트 검색 모달창-->
                            <div id="searchModal" class="modal" >
                                <div class="modal-content">
                                    <span id="searchModalOpenClose" class="close">&times;</span>
                                    <form id="memberSearchForm" method="POST" action="{% url 'signup:member_select' %}">
                                        {% csrf_token %}
                                        <div class="search-container">
                                            <input type="text" class="search-box" placeholder="그룹명 또는 멤버명으로 검색..." id="idolSearch">
                                            <input type="hidden" name="favorite_group" id="selectedGroup">
                                            <input type="hidden" name="favorite_member" id="selectedMember">
                                            <input type="hidden" name="second_group" id="selectedGroup">
                                            <input type="hidden" name="second_member" id="selectedMember">

                                            <div class="filter-buttons">
                                                <button type="button" class="filter-btn" data-filter="all">전체</button>
                                                <button type="button" class="filter-btn" data-filter="boy">보이그룹</button>
                                                <button type="button" class="filter-btn" data-filter="girl">걸그룹</button>
                                            </div>
                                        </div>

                                        <div class="selected-count">선택된 멤버: <span id="selectedCount">0</span>/2명</div>

                                        <div class="selected-members" id="selectedMembers" style="display: none;">
                                            <h3>🌟 선택된 멤버</h3>
                                            <div class="selected-list" id="selectedList"></div>
                                        </div>

                                        <div class="search-noticeBox" id="searchNotice">
                                            <span class="icon">🔍</span>
                                            <div class="main-text">검색어를 입력하여 아이돌 그룹을 찾아보세요!</div>
                                            <div class="sub-text">그룹명 또는 멤버명으로 검색 가능합니다</div>
                                        </div>
                                        
                                        <div class="groups-container" id="groupsContainer"></div>
                                        <div id="hiddenInputsContainer"></div>
                                        <button id="completeBtn" class="btn btn-primary" type="button" disabled>완료</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>



        <div class="content">
            <div class="tabs-wrapper">
                <div class="tabs">
                    <button class="tab active " onclick="showTab('keywords')">키워드</button>
                    <button class="tab" onclick="showTab('recent')">최근본글</button>
                    <button class="tab" onclick="showTab('mypoca')">마이 포카</button>
                    <button class="tab" onclick="showTab('wishlist')" >위시리스트</button>
                    <button class="tab" onclick="showTab('transactions')">포토카드</button>
                    <button class="tab" onclick="showTab('reviews')">후기글</button>
                    <button class="tab" onclick="showTab('community')">커뮤니티 작성글</button>
                    <button class="tab" onclick="showTab('blocked')">블랙리스트</button>
                </div>
            </div>
            <!--키워드 리스트-->
            <div id="keywords" class="tab-content active">
                <div class="section-content">
                    <div class="item">
                        <h3>관심 그룹 키워드</h3>
                        <p>
                            {%for group in groups%}
                                #{{group.name}}
                            {%endfor%}
                        </p>
                    </div>
                    <div class="item">
                        <h3>관심 멤버 키워드</h3>
                        <p>
                            {%for member in members%}
                                #{{member.name}}
                            {%endfor%}
                        </p>
                    </div>
                </div>
            </div>

            <!--최신본글-->
            <div id="recent" class="tab-content">
                <div class="section-content"></div>
            </div>

            <!--마이포카-->
            <div id="mypoca" class="tab-content">
                <div class="cards-header">
                    <button class="back-btn" onclick="showAlbumList()" style="display: none;">← 앨범 목록으로</button>
                </div>
                
                <!-- 앨범 목록 뷰 -->
                <div class="section-content">
                    <div id="album-list" class="album-grid"></div>
                </div>

                
                <!-- 포토카드 목록 뷰 (기본적으로 숨김)/ 구현방안 고민중 -->
                <div id="photocard-list" style="display: none;">
                    <div id="current-album-title" class="current-album"></div>
                    <div class="section-content">
                        <div class="photocard-grid"></div>
                    </div>
                </div>

            </div>

            <!--위시리스트-->
            <div id="wishlist" class="tab-content">
                <div class="section-content"></div>
            </div>

            <div id="transactions" class="tab-content">
                <div class="section-header">
                    <div class="transaction-tabs">
                        <button class="transaction-tab active" onclick="showTransactionTab('selling')">판매목록</button>
                        <button class="transaction-tab" onclick="showTransactionTab('buying')">구매목록</button>
                        <button class="transaction-tab" onclick="showTransactionTab('exchange')">교환목록</button>
                    </div>
                </div>
                
                <div class="section-content">
                    <!--판매목록-->
                    <div id="selling-list" class="transaction-content"></div>
                    <!--구매목록-->
                    <div id="buying-list" class="transaction-content" style="display: none;"></div>
                    <!--교환목록-->
                    <div id="exchange-list" class="transaction-content" style="display: none;"></div>
                </div>
            </div>

            <div id="reviews" class="tab-content">
                <div class="section-header">
                    <div class="review-tabs">
                        <button class="review-tab active" onclick="showReviewTab('received')">내가 받은 후기</button>
                        <button class="review-tab" onclick="showReviewTab('written')">내가 쓴 후기</button>
                    </div>
                </div>
                
                <!--내가 받은 거래 후기-->
                <div class="section-content">
                    <div id="received-reviews" class="review-content"></div>
                </div>

                <!--내가 쓴 후기-->
                <div class="section-content">
                    <div id="written-reviews" class="review-content" style="display: none;"></div>
                </div>
            </div>

            <div id="community" class="tab-content">
                <div class="section-header">
                    <div class="community-tabs">
                        <button class="community-tab active" onclick="showCommunityTab('WithU')">동행</button>
                        <button class="community-tab " onclick="showCommunityTab('Sharing')">나눔</button>
                        <button class="community-tab " onclick="showCommunityTab('Insteadbuy')">대리구매</button>
                        <button class="community-tab " onclick="showCommunityTab('shareNow')">현황공유</button>
                    </div>
                </div>

                <!--동행글-->
                <div class="section-content">
                    <div id="WithU" class="community-content"></div> 
                </div>
                <!--나눔글-->
                <div class="section-content">
                    <div id="Sharing" class="community-content" style="display: none;"></div> 
                </div>
                <!--대리구매-->
                <div class="section-content">
                    <div id="Insteadbuy" class="community-content" style="display: none;"></div> 
                </div>
                <!--현황공유-->
                <div class="section-content">
                    <div id="shareNow" class="community-content" style="display: none;"></div> 
                </div>
            </div>

            <!--블랙리스트-->
            <div id="blocked" class="tab-content">
                <div class="section-header">
                    <div class="blocked-tabs">
                        <button class="blocked-tab active" onclick="showBlockedTab('blocked-user')">내가 차단한 사용자</button>
                        <button class="blocked-tab" onclick="showBlockedTab('blocked-post')">내가 신고한 글</button>
                    </div>
                </div>

                <!--차단한사용자-->
                <div class="section-content">
                    <div id="blocked-user" class="blocked-content"> </div>
                </div>

                <!--신고한 글-->
                <div class="section-content">
                    <div id="blocked-post" class="blocked-content" style="display: none;"></div>
                </div>
            </div>
            <!--//블랙리스트-->
        </div>
    </main>
    
<script>
    // 파일업로드 관련
    const imageuploadContainer = document.getElementById('previous_container');
    const imageInput = document.getElementById('profile-img-input');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const previousImage = document.getElementById('previousImage');

    imageuploadContainer.addEventListener('click',()=>imageInput.click());

    imageuploadContainer.addEventListener('dragover',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.add('dragover');
    });

    imageuploadContainer.addEventListener('dragleave',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.remove('dragover');
    });

    imageuploadContainer.addEventListener('drop',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if(files.length > 0 ){
            handleFile(files[0]);
        }
    });

    imageInput.addEventListener('change',(e)=>{
        if(e.target.files.length>0){
            handleFile(e.target.files[0]);
        }
    });

    // 이미지 미리보기 함수
    function handleFile(file) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.style.display = "block";
                previousImage.style.display = "none"; // 기존 이미지 숨김
            };
            reader.readAsDataURL(file);
        } else {
            alert("이미지 파일만 업로드할 수 있습니다.");
        }
    }

    // #Recent AJAX
    $.ajax({
        url: "/mypage/latest/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        success: function (data) {
            console.log('최근 게시글 연결 성공')

            const recentList = $("#recent .section-content");
            
            const cardsHtml = data.photocards.map(card => {
                const dateType = card.created_at.split('T')[0];

                return `
                    <a href="/photocard/detail/${ card.pno }">
                        <div class="item" data-pno="${ card.pno }">
                            <div>
                                <h3>${card.title}</h3>
                                <p>${dateType} - ${card.album}</p>
                            </div> 
                        </div>
                    </a>`}).join("");

            recentList.html(cardsHtml || "<div class='error-content'>최근 본 글이 없습니다.</div>");
        },
        error: function () {
            console.error("최근 본 글 불러오기 실패");
            recentList.html("<div class='error-content'>최근 본 글을 불러오는 데 실패했습니다.</div>");
        }
    });

    // #mypoca AJAX
    $.ajax({
        url: "/mypage/mypoca/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function (data) {
            console.log("받은 데이터:", data.group_album_dict);

            const albumList = $("#mypoca #album-list");
            albumList.empty(); // 기존 목록 비우기

            const groupAlbumDict = data.group_album_dict;
            let hasPhotocards = false;  // 포토카드 존재 여부 체크

            for (let groupName in groupAlbumDict) {
                const albumMap = groupAlbumDict[groupName];

                for (let albumName in albumMap) {
                    const photocards = albumMap[albumName];

                    if(!photocards || photocards.length === 0) continue;
                    hasPhotocards = true;

                    const firstCard = photocards[0]; // 대표 이미지
                    const imageUrl = firstCard.image_url || '{/static/images/default.jpg}';
                    const cardCount = photocards.length;

                    const albumCard = `
                    <a href="/photocard/detail/${firstCard.pno}">
                        <div class="album-card" onclick="showPhotoCards('${groupName}-${albumName}')">
                            <div class="album-cover">
                                <img src="${imageUrl}" alt="${albumName}">
                            </div>
                            <div class="album-info">
                                <h4>${albumName}</h4>
                                <p>${groupName}</p>
                                <span class="card-count">${cardCount}장</span>
                            </div>
                        </div>
                    </a>
                    `;

                    albumList.append(albumCard);
                }

            }
            // 포토카드가 없는 경우
            if(!hasPhotocards) {
                $("#mypoca .section-content").html("<div class='error-content'>보유한 포토카드가 없습니다.</div>");
            }            
        },
        error: function (xhr, status, error) {
            console.error("마이포카 불러오기 실패");
            $("#mypoca .section-content").html("<div class='error-content'>보유한 포토카드를 불러오는 데 실패했습니다.</div>");
        }
    });

    // #wishlist AJAX
    $.ajax({
        url: "/mypage/wishlist/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: 'json',
        success: function(data){
            console.log('위시리스트 연결 성공',data.wishlist);
            // 기존 목록 비우기
            const wishList = $("#wishlist .section-content");
            wishList.empty();

            const wishdata = data.wishlist.map(wish => 
                `<div class="item">
                    <a href="/photocard/detail/${wish.pno}">
                        <div class="wishlist">
                            <div class="wish-list-img">
                                <img src=${wish.image_url}>
                            </div>
                            <div class="wish-list-txt">
                                <span class="badge reserved">거래${wish.trade_state}</span>
                                <h3>${wish.title}
                                </h3>
                                <p>${wish.album}</p>
                            </div>
                        </div>
                    </a>
                </div>`).join("");
            wishList.append(wishdata || "<div class='error-content'>위시리스트 목록이 없습니다.</div>")
        },
        error: function (xhr, status, error) {
            console.error("위시리스트 불러오기 실패");
            wishList.html("<div class='error-content'>위시리스트를 불러오는 데 실패했습니다.</div>");
        }
    });

    // 판매 목록 AJAX
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('판매목록 불러오기 성공');

            const saleList = $("#transactions #selling-list");
            saleList.empty();

            const saleData = data.sell_poca.map(sell => 
                `<div class="item">
                <a href="/photocard/detail/${sell.pno}">
                    <h3>${sell.title}</h3>
                    <p>${sell.album} | 상태: 거래${sell.trade_state}</p>
                </a>
                </div>`).join("");

            saleList.html(saleData||"<div class='error-content'>판매목록이 없습니다.</div>");
        }, error: function(xhr, status, error){
            console.error("판매목록 불러오기 실패");
            saleList.html("<div class='error-content'>판매목록을 불러오는 데 실패했습니다.</div>");
        }
    });
    // 구매 목록 AJAX
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('구매목록 불러오기 성공');

            const buyList = $("#transactions #buying-list");
            buyList.empty();

            const buyData = data.buy_poca.map(buy => 
                `<div class="item">
                <a href="/photocard/detail/${buy.pno}">
                    <h3>${buy.title}</h3>
                    <p>${buy.album} | 상태: 거래${buy.trade_state}</p>
                </a>
                </div>`).join("");
                buyList.html(buyData||"<div class='error-content'>구매목록이 없습니다.</div>");

        }, error: function(xhr, status, error){
            console.error("판매목록 불러오기 실패");
            buyList.html("<div class='error-content'>구매목록을 불러오는 데 실패했습니다.</div>");
        }
    });
    // 교환 목록 AJAX => 실제 교환목록 리스트로 수정 필요
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('교환목록 불러오기 성공');

            const exchangeList = $("#transactions #exchange-list");
            exchangeList.empty();

            const exchangeData = data.exchange_poca.map(exchange => 
                `<div class="item">
                <a href="/photocard/detail/${exchange.pno}">
                    <h3>${exchange.title}</h3>
                    <p>${exchange.album} | 상태: 거래${exchange.trade_state}</p>
                </a>
                </div>`).join("");

                exchangeList.html(exchangeData||"<div class='error-content'>교환목록이 없습니다.</div>");
        }, error: function(xhr, status, error){
            console.error("교환목록 불러오기 실패");
            exchangeList.html("<div class='error-content'>교환목록을 불러오는 데 실패했습니다.</div>");
        }
    });

    // 유저정보 가져오기
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
        
        // 내가 받은 후기글
        $.ajax({
            url: "/mypage/reviews/received/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('받은 후기글 불러오기 성공');

                const receivedList = $("#reviews #received-reviews");
                receivedList.empty();

                const receivedData = data.received_reviews.map(received => 
                    `<div class="item">
                    <a hred="/community/chgReview/view/${received.post_id}">
                        <h3>작성자: ${received.writer}</h3>
                        <span class="rating">평점 : ${received.overall_score}점⭐⭐⭐⭐⭐</span>
                        <p>${received.title} - ${received.content}</p>
                    </a>
                    </div>
                    `).join("");

                    receivedList.html(receivedData||"<div class='error-content'>받은 후기글 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("받은 후기글 불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>받은 후기글 불러오는 데 실패했습니다.</div>");
            }
        });
        // 내가 쓴 후기글
        $.ajax({
            url: "/mypage/reviews/written/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('쓴 후기글 불러오기 성공');

                const writtenList = $("#reviews #written-reviews");
                writtenList.empty();

                const writtenData = data.written_reviews.map(written => 
                    `<div class="item">
                    <a hred="/community/chgReview/view/${written.post_id}">
                        <h3>제목: ${written.title} </h3>
                        <p>작성자 : ${written.partner__nickname}</p>
                        <p class="rating">평점 : ${written.overall_score}⭐⭐⭐⭐⭐</p>
                        <p class=".review-content">${written.content}</p>
                    </a>
                    </div>`).join("");

                    writtenList.html(writtenData||"<div class='error-content'>쓴 후기글  없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("쓴 후기글  불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>쓴 후기글  불러오는 데 실패했습니다.</div>");
            }
        });

        // 커뮤니티 - 동행글
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('동행글 불러오기 성공');

                const companionList = $("#community #WithU");
                companionList.empty();


                const companionData = data.companion.map(companion => {
                    `<div class="item">
                    <a href="/community/companion/view/">
                        <h3>${companion.title}</h3>
                        <p>${companion.created_at} - 조회수: ${companion.views} | 댓글: ${companion.comments_count}</p>
                    </a>
                    </div>
                    `}).join("");

                    companionList.html(companionData||"<div class='error-content'>동행글이 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("동행글 불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>동행글을 불러오는 데 실패했습니다.</div>");
            }
        });

        // 커뮤니티 - 나눔글
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('나눔글 불러오기 성공');

                const sharingList = $("#community #Sharing");
                sharingList.empty();

                            
                const sharingData = data.sharing.map(sharing => {
                    `<div class="item">
                    <a href="/community/sharing/view/">
                        <h3>${sharing.title}</h3>
                        <p>${sharing.created_at} - 조회수: ${sharing.views} | 댓글: ${sharing.comments_count}</p>
                    </a>
                    </div>`}).join("");

                sharingList.html(sharingData||"<div class='error-content'>나눔글이 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("나눔글 불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>나눔글을 불러오는 데 실패했습니다.</div>");
            }
        });

        // 커뮤니티 - 대리구매
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('대리구매글 불러오기 성공');

                const InsteadbuyList = $("#community #Insteadbuy");
                InsteadbuyList.empty();


                const InsteadbuyData = data.proxy.map(proxy => {
                    `<div class="item">
                    <a href="/community/proxy/view/">
                        <h3>${proxy.title}</h3>
                        <p>${proxy.created_at} - 조회수: ${proxy.views} | 댓글: ${proxy.comments_count}</p>
                    </a>
                    </div>
                    `}).join("");

                    InsteadbuyList.html(InsteadbuyData||"<div class='error-content'>대리구매글이 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("대리구매글 불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>대리구매글을 불러오는 데 실패했습니다.</div>");
            }
        });
        // 커뮤니티 - 현황공유
        /*
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('현황공유글 불러오기 성공');

                const shareNowList = $("#community #shareNow");
                shareNowList.empty();


                const shareNowData = data.shareNow.map(shareNow => {
                    `<div class="item">
                        <h3>${shareNow.title}</h3>
                        <p>${shareNow.created_at} - 조회수: ${shareNow.views} | 댓글: ${shareNow.comments_count}</p>
                    </div>`}).join("");

                    shareNowList.html(shareNowData||"<div class='error-content'>현황공유글이 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("현황공유글 불러오기 실패");
                $("#reviews #received-reviews").html("<div class='error-content'>현황공유글을 불러오는 데 실패했습니다.</div>");
            }
        });
        */

    // 블랙리스트 - 차단한 사용자 목록 AJAX
    function loadBlockedUsers() {
        $.ajax({
            url: "/mypage/blocklist/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('차단 사용자 불러오기 성공');

                const blockuserList = $("#blocked #blocked-user");
                blockuserList.empty();

                const blockData = data.blocked_users.map(user => 
                    `<div class="item" data-user-id="${user.user_id}">
                        <h3>${user.user_id} - ${user.name}</h3>
                        <button class="unblock-btn" data-user-id="${user.user_id}">차단해제</button>
                        <p>차단 사유: ${user.reason}</p>
                    </div>`).join("");

                blockuserList.append(blockData||"<div class='error-content'>차단 사용자 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("차단 사용자 불러오기 실패",xhr,status,error);
                blockuserList.html("<div class='error-content'>차단 사용자 불러오는 데 실패했습니다.</div>");
            }
        });
    };

    // 동적으로 생성된 요소에는 이벤트 위임 방식 사용
    $(document).on("click", ".unblock-btn", function () {
        const $item = $(this).closest('.item');
        const userId = $item.data('user-id');

        if (!confirm("정말 차단을 해제하시겠습니까?")) return;

        $.ajax({
            url: '/mypage/update_blocklist/',  // URL은 실제 프로젝트에 맞게 수정
            type: 'POST',
            data: JSON.stringify({ id: userId }),  // JSON 형식으로 전송
            contentType: 'application/json',
            headers: {
            'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                showToast('차단해제가 처리되었습니다.');
                loadBlockedUsers();
            },
            error: function(xhr) {
                $('#result').text('오류: ' + (xhr.responseJSON?.error || xhr.responseJSON?.message || '요청 실패'));
                    console.log('error')
            }
        });
    });

    $(document).ready(function(){
        loadBlockedUsers();
    });

    /*
    // 블랙리스트 - 신고한 글 목록 AJAX
    function loadBlockedPosts() {
        $.ajax({
            url: "/mypage/blocklist/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('신고한 글 불러오기 성공');

                const blockpostList = $("#blocked #blocked-post");
                blockpostList.empty();

                const blockpostData = data.blocked_post.map(post => 
                    `<div class="item" data-user-id="${post.user_id}">
                        <h3>${post.user_id} - ${post.name}</h3>
                        <button class="unblock-btn post" data-user-id="${post.user_id}">차단해제</button>
                        <p>차단 사유: ${post.reason}</p>
                    </div>`).join("");

                blockpostList.append(blockpostData||"<div class='error-content'>신고한 글이 없습니다.</div>");
            }, error: function(xhr, status, error){
                console.error("신고한 글 불러오기 실패",xhr,status,error);
                blockpostList.html("<div class='error-content'>신고한 글을 불러오는 데 실패했습니다.</div>");
            }
        });
    };

    // 동적으로 생성된 요소에는 이벤트 위임 방식 사용
    $(document).on("click", ".unblock-btn post", function () {
        const $item = $(this).closest('.item');
        const userId = $item.data('user-id');

        if (!confirm("정말 차단을 해제하시겠습니까?")) return;

        $.ajax({
            url: '/mypage/update_blocklist/',  // URL은 실제 프로젝트에 맞게 수정
            type: 'POST',
            data: JSON.stringify({ id: userId }),  // JSON 형식으로 전송
            contentType: 'application/json',
            headers: {
            'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                showToast('차단해제가 처리되었습니다.');
                loadBlockedUsers();
            },
            error: function(xhr) {
                $('#result').text('오류: ' + (xhr.responseJSON?.error || xhr.responseJSON?.message || '요청 실패'));
                    console.log('error')
            }
        });
    });

    $(document).ready(function(){
        loadBlockedUsers();
    });
    */
    
    // 프로필 수정 업데이트 AJAX
    $('#profileForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        $.ajax({
            url: '/mypage/update_profile/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
            'X-CSRFToken': getCookie('csrftoken')  // CSRF 토큰 필요
            },
            success: function(response) {
                alert("프로필 수정 성공");
            },
            error: function(xhr) {
                alert('오류: ' + xhr.responseJSON?.message || '요청 실패');
            }
        });
    });


    // 아티스트 검색 모달창
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById('searchModal');
        const searchModalOpen = document.getElementById('searchModalOpen');
        const searchModalClose = document.getElementById('searchModalOpenClose');
        const searchInput = document.getElementById('idolSearch');
        const completeBtn = document.getElementById('completeBtn');
        const groupsContainer = document.getElementById('groupsContainer');
        const searchNotice = document.getElementById('searchNotice');
        const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');
        const memberGrid = document.querySelector('.mybias_input');

        let selectedMembers = new Set();
        let currentFilter = 'all';
        
        const mybiasInput = document.querySelector(".mybias_input");
        mybiasInput.addEventListener("click", () => {
            searchModal.style.display = "block";

            // 검색 초기화
            searchInput.value = '';
            searchInput.focus();
            groupsContainer.innerHTML = '';
            searchNotice.style.display = 'block';
            selectedMember = null;
            completeBtn.disabled = true;

        });  
        
        // 모달 닫기
        searchModalClose.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', e => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // 선택된 멤버 업데이트
        function updateSelectedDisplay() {
            const count = document.getElementById('selectedCount');
            const container = document.getElementById('selectedMembers');
            const list = document.getElementById('selectedList');
            count.textContent = selectedMembers.size;

            if (selectedMembers.size === 0) {
            container.style.display = 'none';
            completeBtn.disabled = true;
            } else {
            container.style.display = 'block';
            completeBtn.disabled = false;
            list.innerHTML = Array.from(selectedMembers).map(item => {
                const [group, member] = item.split('-');
                return `
                <div class="selected-item">
                    <span>${group} - ${member}</span>
                    <button class="remove-btn" data-item="${item}">×</button>
                </div>
                `;
            }).join('');
            }
        }

        // 선택된 멤버 취소 
        groupsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-btn')) {
                const item = e.target.dataset.item;
                selectedMembers.delete(item);
                updateSelectedDisplay();
                // 버튼에서 selected 클래스 제거
                document.querySelectorAll('.member-toggle').forEach(btn => {
                    const key = `${btn.dataset.group}-${btn.dataset.member}`;
                    if (key === item) {
                        btn.classList.remove('selected');
                    }
                });
            }
        });

        // 검색 처리
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim();
            if (!query) {
                groupsContainer.innerHTML = '';
                searchNotice.style.display = 'block';
                return;
            }

            // api query
            fetch(`/idols/search/?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    groupsContainer.innerHTML = '';
                    searchNotice.style.display = 'none';
                    completeBtn.disabled = true;


                    // 검색된 결과가 여러명 경우
                    const groups = {};
                    data.members.forEach(m => {
                        const group = m.group__name;
                        if (!groups[group]) {
                            groups[group] = { gender: m.group__gender, members: [] };
                        }
                        groups[group].members.push(m);
                    });

                    Object.entries(groups).forEach(([groupName, info]) => {
                        const groupCard = document.createElement('div');
                        groupCard.className = 'group-card';
                        const typeClass = info.gender === "M" ? "boy-group" : "girl-group";

                        groupCard.innerHTML = `
                            <div class="group-header">
                                <div class="group-name">${groupName}</div>
                                <div class="group-type ${typeClass}">
                                    ${info.gender === "M" ? "보이그룹" : "걸그룹"}
                                </div>
                            </div>
                            <div class="members-grid">
                                ${info.members.map(member => {
                                    const isSelected = selectedMember && selectedMember.group === groupName && selectedMember.member === member.name;
                                    return `
                                        <button type="button" class="member-toggle ${isSelected ? 'selected' : ''}"
                                            data-group="${groupName}" data-member="${member.name}">
                                            ${member.name}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        groupsContainer.appendChild(groupCard);
                    });
                });
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('member-toggle') && !e.target.classList.contains('disabled')) {
            const group = e.target.dataset.group;
            const member = e.target.dataset.member;
            const key = `${group}-${member}`;

            if (selectedMembers.has(key)) {
                selectedMembers.delete(key);
                e.target.classList.remove('selected');
            } else {
                if (selectedMembers.size < 2) {
                selectedMembers.add(key);
                e.target.classList.add('selected');
                }
            }

            updateSelectedDisplay();
            }

            if (e.target.classList.contains('remove-btn')) {
            const item = e.target.dataset.item;
            selectedMembers.delete(item);
            updateSelectedDisplay();
            document.getElementById("idolSearch").dispatchEvent(new Event("input"));
            }
        });

        // 완료 버튼 클릭
        completeBtn.addEventListener('click', () => {
            if (selectedMembers.size === 0) return;
            
            // hidden input, 렌더링 초기화
            hiddenInputsContainer.innerHTML = '';
            memberGrid.innerHTML = '';

            // 선택된 멤버 순서대로 분리
            const selectedArray = Array.from(selectedMembers);
            selectedArray.forEach((item, index) => {
                const [group, member] = item.split('-');

                // hidden input 생성 (favorite, second 구분)
                const groupInputName = index === 0 ? 'favorite_group' : 'second_group';
                const memberInputName = index === 0 ? 'favorite_member' : 'second_member';

                hiddenInputsContainer.innerHTML += `
                    <input type="hidden" name="${groupInputName}" value="${group}">
                    <input type="hidden" name="${memberInputName}" value="${member}">
                `;

                // 메인 입력 필드 렌더링
                memberGrid.innerHTML += `
                    <input type="text" name="mybias" value="${group} - ${member}" readonly style="cursor: pointer;">
                `;
            });

            // 모달 닫기
            modal.style.display = 'none';
        });

        // 필터 버튼 처리
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                searchInput.dispatchEvent(new Event('input'));
            });
        });

    });

</script>

{%endblock%}
<!--//상단헤더-->

</body>
</html>