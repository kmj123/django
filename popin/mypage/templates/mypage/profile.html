{% extends 'header_login.html'%}
{% load static %}
<!--ìƒë‹¨ í—¤ë”-->
{%block content%}

<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8">
        <meta name="csrf-token" content="{{ csrf_token}}">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="/static/css/mypage.css">
        <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
        <title>{%block title%}ë§ˆì´í˜ì´ì§€{%endblock%}</title>
    </head>
    <style>
        .modal{
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content{
            border-radius: 8px;
            width: 100%;
            max-width: 100%;
            background-color: #ffff;
            FONT-WEIGHT: 200;
            /* margin: 20px auto; */
            padding: 65px;
            max-height: 100%;
            overflow-y: auto;
        }

        .close {
        position: block;
        top: 10px;
        right: 16px;
        font-size: 28px;
        cursor: pointer;
        }
        /*ê²€ìƒ‰css*/

        .search-container {
        margin-bottom: 1.5rem;
        display: flex;
        flex-direction: column;
        gap: 15px;
        align-items: center;
        }

        .search-box {
        padding: 12px 20px;
        border: 2px solid #ddd;
        border-radius: 25px;
        font-size: 16px;
        width: 100%;
        transition: all 0.3s ease;
        }

        .search-box:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 10px rgba(102, 126, 234, 0.3);
        }

        .filter-buttons {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
        }

        .filter-btn {
        padding: 8px 16px;
        border: 2px solid #667eea;
        background: white;
        color: #667eea;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 14px;
        }

        .filter-btn.active, .filter-btn:hover {
        background: #667eea;
        color: white;
        }

        .selected-count {
        text-align: center;
        margin-bottom: 20px;
        font-size: 18px;
        color: #333;
        font-weight: bold;
        }

        .selected-members {
        background: #f8f9fa;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 20px;
        }

        .selected-members h3 {
        margin-bottom: 15px;
        color: #333;
        }

        .selected-list {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        }

        .selected-item {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        padding:15px;
        border-radius: 15px;
        font-size: 14px;
        display: flex;
        align-items: center;
        gap: 8px;
        }

        .remove-btn {
        background: rgba(255, 255, 255, 0.3);
        border: none;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        cursor: pointer;
        color: white;
        font-size: 12px;
        }

        .search-noticeBox {
        text-align: center;
        padding: 40px 20px;
        background: linear-gradient(135deg, #f8f9ff 0%, #f0f4ff 100%);
        border: 2px dashed #667eea;
        border-radius: 20px;
        margin: 20px 0;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.1);
        }

        .search-notice .icon {
        font-size: 48px;
        margin-bottom: 15px;
        display: block;
        }

        .search-notice .main-text {
        color: #667eea;
        font-size: 16px;
        font-weight: 600;
        margin-bottom: 8px;
        }

        .search-notice .sub-text {
        font-size: 14px;
        color: #999;
        }

        .groups-container {
            display: grid;
            gap: 20px;
        }

        .group-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
        }

        .group-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        }

        .group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #f0f0f0;
        }

        .group-name {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
        }

        .group-type {
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 12px;
        font-weight: bold;
        }

        .boy-group {
        background: #e3f2fd;
        color: #1976d2;
        }

        .girl-group {
        background: #fce4ec;
        color: #c2185b;
        }

        .members-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        }

        .member-toggle {
        padding: 8px 12px;
        border: 2px solid #ddd;
        background: white;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        font-size: 12px;
        font-weight: 500;
        }

        .member-toggle:hover {
        border-color: #667eea;
        transform: translateY(-2px);
        }

        .member-toggle.selected {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
        border-color: #667eea;
        box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .member-toggle.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
        }

        .selection-limit-notice {
        background: #fff3cd;
        border: 1px solid #ffeaa7;
        color: #856404;
        padding: 10px 15px;
        border-radius: 10px;
        margin-bottom: 15px;
        text-align: center;
        font-size: 14px;
        }
        .btn {
        width: 100%;
        padding: 1rem;
        border: none;
        border-radius: 10px;
        font-size: 1.1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        }

        .btn-primary {
        background: linear-gradient(45deg, #667eea, #764ba2);
        color: white;
        margin-top: 1.5rem;
        }

        .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
        background: #ccc;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
        }

        #toast{
            visibility: hidden;
            min-width: 304px;
            margin-left:-125px;
            background-color:rgba(120,120,120 ,0.8);
            color:#fff;
            text-align:center;
            border-radius: 6px;
            position: fixed;
            z-index: 9999;
            left: 50%;
            bottom: 50%;
            font-size:12px;
            opacity: 0;
            trasition: opacity 0.5s, bottom: 0.5s;
            padding:20px;
        }

        #toast.show{
            visibility:visible;
            opacity: 1;
            bottom: 50%;
        }

    </style>

    <script>
        // í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ì°½ ìŠ¤í¬ë¦½íŠ¸
        document.addEventListener('DOMContentLoaded', function () {
            const modalOpenButton = document.getElementById('profile_modal');
            const modalSaveButton = document.getElementById('favorite-btnSave');
            const modalCloseButton = document.getElementById('favorite-btnClose');
            const modal = document.getElementById('modalContainer');

            // ëª¨ë‹¬ì°½ ì˜¤í”ˆ
            modalOpenButton.addEventListener('click', () => {
                modal.classList.remove('hidden');
            });

            // ëª¨ë‹¬ì°½ ì €ì¥
            modalSaveButton.addEventListener('click', () => {
                modal.classList.add('hidden');
            });

            // ëª¨ë‹¬ì°½ ë‹«ê¸°
            modalCloseButton.addEventListener('click',() => {
                modal.classList.add('hidden');
            });
        });
        //ëª¨ë‹¬ì°½ìŠ¤í¬ë¦½íŠ¸

        // ì „ì²´ ì¹´í…Œê³ ë¦¬
        function showTab(tabName) {
            const contents = document.querySelectorAll('.tab-content');
            const tabs = document.querySelectorAll('.tab');
            // ëª¨ë“  íƒ­ ì½˜í…ì¸  ìˆ¨ê¸°ê¸°
            contents.forEach(content => {
                content.classList.remove('active');
            });

            // ëª¨ë“  íƒ­ ë²„íŠ¼ ë¹„í™œì„±í™”
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // ì„ íƒëœ íƒ­ ì½˜í…ì¸  ë³´ì´ê¸°
            document.getElementById(tabName).classList.add('active');

            // ì„ íƒëœ íƒ­ ë²„íŠ¼ í™œì„±í™”
            event.target.classList.add('active');
        }

        // êµí™˜ê±°ë˜ ì¹´í…Œê³ ë¦¬
        function showTransactionTab(type) {
            const transactionTabs = document.querySelectorAll('.transaction-tab');
            const transactionContents = document.querySelectorAll('.transaction-content');
            const sellingList = document.getElementById('selling-list');
            const buyingList = document.getElementById('buying-list');
            const exchangeList = document.getElementById('exchange-list');
            // êµí™˜ê±°ë˜ íƒ­ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            transactionTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // êµí™˜ê±°ë˜ ì½˜í…ì¸ ë“¤ ìˆ¨ê¸°ê¸°
            transactionContents.forEach(content => {
                content.style.display = 'none';
            });

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            
            // ì„ íƒëœ ì½˜í…ì¸  ë³´ì´ê¸°
            if (type === 'selling') {
                sellingList.style.display = 'block';
            } else if(type==='buying'){
                buyingList.style.display = 'block';
            } else if(type==='exchange'){
                exchangeList.style.display='block';
            }
        }

        // í›„ê¸° ì¹´í…Œê³ ë¦¬
        function showReviewTab(type) {
            const reviewTabs = document.querySelectorAll('.review-tab');
            const reviewContents = document.querySelectorAll('.review-content');
            // í›„ê¸° íƒ­ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            reviewTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // í›„ê¸° ì½˜í…ì¸ ë“¤ ìˆ¨ê¸°ê¸°
            reviewContents.forEach(content => {
                content.style.display = 'none';
            });

            // ì„ íƒëœ íƒ­ í™œì„±í™”
            event.target.classList.add('active');
            
            // ì„ íƒëœ ì½˜í…ì¸  ë³´ì´ê¸°
            if (type === 'received') {
                document.getElementById('received-reviews').style.display = 'block';
            } else {
                document.getElementById('written-reviews').style.display = 'block';
            }
        }

        // ì»¤ë®¤ë‹ˆí‹° ì¹´í…Œê³ ë¦¬ 
        function showCommunityTab(type){
            const communityTabs = document.querySelectorAll('.community-tab');
            const communityContents = document.querySelectorAll('.community-content');
            const WithU = document.getElementById('WithU');
            const Sharing = document.getElementById('Sharing');
            const Insteadbuy = document.getElementById('Insteadbuy');
            const shareNow = document.getElementById('shareNow');

            communityTabs.forEach(tab=>{
                tab.classList.remove('active');
            });

            communityContents.forEach(content=>{
                content.style.display="none";
            })

            event.target.classList.add('active');

            if (type === "WithU"){
                WithU.style.display="block";
            } else if(type === "Sharing"){
                Sharing.style.display="block";
            } else if(type === "Insteadbuy"){
                Insteadbuy.style.display="block";
            } else if(type === "shareNow"){
                shareNow.style.display="block";
            }
        }

        // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì¹´í…Œê³ ë¦¬
        function showBlockedTab(type){
            const blockedTabs = document.querySelectorAll('.blocked-tab');
            const blockedContents = document.querySelectorAll('.blocked-content')
            const blockeduser = document.getElementById('blocked-user');
            const blockedpost = document.getElementById('blocked-post');

            // ë¸”ë™ë¦¬ìŠ¤íŠ¸ íƒ­ ë²„íŠ¼ë“¤ ë¹„í™œì„±í™”
            blockedTabs.forEach(tab => {
                tab.classList.remove('active');
            });

            // ë¸”ë™ë¦¬ìŠ¤íŠ¸ ì½˜í…ì¸ ë“¤ ìˆ¨ê¸°ê¸°
            blockedContents.forEach(content => {
                content.style.display = 'none';
            });

            event.target.classList.add('active');

            // ì„ íƒëœ ì½˜í…ì¸  ë³´ì´ê¸°
            if (type === 'blocked-user') {
                blockeduser.style.display = 'block';
            } else {
                blockedpost.style.display = 'block';
            }
        }
        
        // ì•¨ë²” -> 
        function showPhotoCards(albumId) {
            const albumData = photocardData[albumId];
            if (!albumData) return;

            // ì•¨ë²” ëª©ë¡ ìˆ¨ê¸°ê¸°
            document.getElementById('album-list').style.display = 'none';
            
            // í¬í† ì¹´ë“œ ëª©ë¡ ë³´ì´ê¸°
            document.getElementById('photocard-list').style.display = 'block';
            
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ë³´ì´ê¸°
            document.querySelector('.back-btn').style.display = 'inline-block';
            
            // í˜„ì¬ ì•¨ë²” ì œëª© ì„¤ì •
            document.getElementById('current-album-title').textContent = albumData.title;
            
            // í¬í† ì¹´ë“œ ê·¸ë¦¬ë“œ ìƒì„±
            const photocardGrid = document.querySelector('.photocard-grid');
            photocardGrid.innerHTML = '';
            
            albumData.cards.forEach(card => {
                const photocardElement = document.createElement('div');
                photocardElement.className = 'photocard';
                photocardElement.innerHTML = `
                    <div class="photocard-img">
                        <img src="${card.img}" alt="${card.member}">
                    </div>
                    <h5>${card.member}</h5>
                    <p>${card.type}</p>
                    `;
                photocardGrid.appendChild(photocardElement);
            });
        }

        function showAlbumList() {
            // í¬í† ì¹´ë“œ ëª©ë¡ ìˆ¨ê¸°ê¸°
            document.getElementById('photocard-list').style.display = 'none';
            
            // ì•¨ë²” ëª©ë¡ ë³´ì´ê¸°
            document.getElementById('album-list').style.display = 'grid';
            
            // ë’¤ë¡œê°€ê¸° ë²„íŠ¼ ìˆ¨ê¸°ê¸°
            document.querySelector('.back-btn').style.display = 'none';
        }

        // ë³€ê²½í•˜ê¸° ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.change-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                alert('ë³€ê²½ ê¸°ëŠ¥ì´ ì‹¤í–‰ë©ë‹ˆë‹¤.');
            });
        });

        // toast ê¸°ëŠ¥êµ¬í˜„
        function showToast(message, duration = 2000) {
            const toast = document.getElementById("toast");
            toast.textContent = message;
            toast.className = "show";

            // ì¼ì • ì‹œê°„ í›„ í† ìŠ¤íŠ¸ ìˆ¨ê¸°ê¸°
            setTimeout(() => {
                toast.className = toast.className.replace("show", "");
            }, duration);   
        }

        
        // ì°¨ë‹¨í•´ì œ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
        document.querySelectorAll('.unblock-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                if(confirm('ì •ë§ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                    this.parentElement.remove();
                }
            });
        });
    </script>

    <body>
    <!--toastìš©-->
    <div id="toast" class="toast"></div> 

    <!--í”„ë¡œí•„-->
    <main class="main">
        <form>
            <div class="profile-card">
                <div class="profile-header">
                    <div class="polaroid" id="profile_modal">
                        <div class="polaroid-image">
                            <!--í´ë¦­ì‹œ í”„ë¡œí•„ë³€ê²½í˜ì´ì§€ ì´ë™-->
                            {%if profile_image%}
                            <img src='/media/{{profile_image}}/' alt='{{profile_image}}'>
                            {%else%}
                            <img src='/static/images/no-image.png/' alt='(ì´ë¯¸ì§€ ì—†ìŒ)' style="object-fit: none;">
                            {%endif%}
                        </div>
                        
                        <!-- í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ì°½ ì˜¤í”ˆ -->
                        <button id="favorite-btn" type="button">

                            {%if group_logo %}
                                <img src="/media/{{group_logo}}/" alt="group_logo">
                            {%else%}
                                <img src="(ë¡œê³ ì—†ìŒ)" alt="(ë¡œê³ ì—†ìŒ)"> 
                            {%endif%}
                        </button>
                    </div>
                    <div class="profile-info">
                        <h1>{{nickname}}</h1>
                        <h3>"{{introduction}}"</h3>
                        <br>
                        
                        <div class="stats">
                            <div class="stat">
                                <div class="stat-number">{{selling_photocards}}</div>
                                <div>ë³´ìœ  í¬ì¹´</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">{{completed}}</div>
                                <div>êµí™˜ ì™„ë£Œ</div>
                            </div>
                            <div class="stat">
                                <div class="stat-number">{{manners_score}}</div>
                                <div>í‰ì </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
        <!--//í”„ë¡œí•„-->

        <!--í”„ë¡œí•„ ìˆ˜ì • ëª¨ë‹¬ì°½ êµ¬í˜„-->
        <form action="/mypage/update_profile/" method="post" name="profileFrm" enctype="multipart/form-data">
            {% csrf_token %}
            <div id="modalContainer" class="hidden">
                <div id="modalContent">
                    <div class="profileTop">
                        <button id="favorite-btnClose" type="button">
                            <img src="/static/images/mypage/cancelicon.png" style="width: 40px; height: 40px;">
                        </button>
                        <h1>í”„ë¡œí•„ ìˆ˜ì •</h1>
                    </div>
                    <div class="profileContent">
                        <label for="profile_image">í”„ë¡œí•„ ì´ë¯¸ì§€</label>
                        <div class="profile_img_container">
                            <div class="profile_img_wrapper">
                                <div class="previous_container" id="previous_container" style="cursor:pointer;">
                                    <img id="previousImage" src="/media/{{ profile_image }}/" class="profile_image" alt="í”„ë¡œí•„ ì´ë¯¸ì§€">
                                </div>
                                <input type="file" id="profile-img-input" name="profile_image" class="fileType" accept="image/*" style="display:none;">
                            </div>
                            <div class="preview-container" id="previewContainer" style="display:none;">
                                <img id="previewImage" class="preview-image" alt="ë¯¸ë¦¬ë³´ê¸°">
                            </div>
                        </div>
                        <div class="myinfo">
                            <div class="myinfo-profile">
                                <label for="nickname">ë‹‰ë„¤ì„</label>
                                <input type="text" id="nickname" name="nickname" value="{{ nickname }}">
                            </div>
                            <div class="myinfo-profile">
                                <label for="mybias">ë§ˆì´ ì•„í‹°ìŠ¤íŠ¸</label>
                                {% for group,member in bias_pairs %}
                                    {%if forloop%}
                                    <div class="mybias_input">
                                    <input type="text" id="mybias" name="mybias" value="{{ group.name }} - {{member.name}}" readonly style="cursor: pointer;">
                                    {%endif%}
                                </div>
                                {% endfor %}
                            </div>
                            <div class="myinfo-profile">
                                <label for="myself">ìê¸°ì†Œê°œ</label>
                                <input type="text" id="myself" name="introduction" value="{{ introduction }}">
                            </div>
                            <div class="myinfo-profile">
                                <button id="favorite-btnSave" type="submit">ë³€ê²½ì‚¬í•­ ì €ì¥</button>
                            </div>

                            <!--ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰ ëª¨ë‹¬ì°½-->
                            <div id="searchModal" class="modal" >
                                <div class="modal-content">
                                    <span id="searchModalOpenClose" class="close">&times;</span>
                                    <form id="memberSearchForm" method="POST" action="{% url 'signup:member_select' %}">
                                        {% csrf_token %}
                                        <div class="search-container">
                                            <input type="text" class="search-box" placeholder="ê·¸ë£¹ëª… ë˜ëŠ” ë©¤ë²„ëª…ìœ¼ë¡œ ê²€ìƒ‰..." id="idolSearch">
                                            <input type="hidden" name="favorite_group" id="selectedGroup">
                                            <input type="hidden" name="favorite_member" id="selectedMember">
                                            <input type="hidden" name="second_group" id="selectedGroup">
                                            <input type="hidden" name="second_member" id="selectedMember">

                                            <div class="filter-buttons">
                                                <button type="button" class="filter-btn" data-filter="all">ì „ì²´</button>
                                                <button type="button" class="filter-btn" data-filter="boy">ë³´ì´ê·¸ë£¹</button>
                                                <button type="button" class="filter-btn" data-filter="girl">ê±¸ê·¸ë£¹</button>
                                            </div>
                                        </div>

                                        <div class="selected-count">ì„ íƒëœ ë©¤ë²„: <span id="selectedCount">0</span>/2ëª…</div>

                                        <div class="selected-members" id="selectedMembers" style="display: none;">
                                            <h3>ğŸŒŸ ì„ íƒëœ ë©¤ë²„</h3>
                                            <div class="selected-list" id="selectedList"></div>
                                        </div>

                                        <div class="search-noticeBox" id="searchNotice">
                                            <span class="icon">ğŸ”</span>
                                            <div class="main-text">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì—¬ ì•„ì´ëŒ ê·¸ë£¹ì„ ì°¾ì•„ë³´ì„¸ìš”!</div>
                                            <div class="sub-text">ê·¸ë£¹ëª… ë˜ëŠ” ë©¤ë²„ëª…ìœ¼ë¡œ ê²€ìƒ‰ ê°€ëŠ¥í•©ë‹ˆë‹¤</div>
                                        </div>
                                        
                                        <div class="groups-container" id="groupsContainer"></div>
                                        <div id="hiddenInputsContainer"></div>
                                        <button id="completeBtn" class="btn btn-primary" type="button" disabled>ì™„ë£Œ</button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>



        <div class="content">
            <div class="tabs-wrapper">
                <div class="tabs">
                    <button class="tab active " onclick="showTab('keywords')">í‚¤ì›Œë“œ</button>
                    <button class="tab" onclick="showTab('recent')">ìµœê·¼ë³¸ê¸€</button>
                    <button class="tab" onclick="showTab('mypoca')">ë§ˆì´ í¬ì¹´</button>
                    <button class="tab" onclick="showTab('wishlist')" >ìœ„ì‹œë¦¬ìŠ¤íŠ¸</button>
                    <button class="tab" onclick="showTab('transactions')">í¬í† ì¹´ë“œ</button>
                    <button class="tab" onclick="showTab('reviews')">í›„ê¸°ê¸€</button>
                    <button class="tab" onclick="showTab('community')">ì»¤ë®¤ë‹ˆí‹° ì‘ì„±ê¸€</button>
                    <button class="tab" onclick="showTab('blocked')">ë¸”ë™ë¦¬ìŠ¤íŠ¸</button>
                </div>
            </div>
            <!--í‚¤ì›Œë“œ ë¦¬ìŠ¤íŠ¸-->
            <div id="keywords" class="tab-content active">
                <div class="section-content">
                    <div class="item">
                        <h3>ê´€ì‹¬ ê·¸ë£¹ í‚¤ì›Œë“œ</h3>
                        <p>
                            {%for group in groups%}
                                #{{group.name}}
                            {%endfor%}
                        </p>
                    </div>
                    <div class="item">
                        <h3>ê´€ì‹¬ ë©¤ë²„ í‚¤ì›Œë“œ</h3>
                        <p>
                            {%for member in members%}
                                #{{member.name}}
                            {%endfor%}
                        </p>
                    </div>
                </div>
            </div>

            <!--ìµœì‹ ë³¸ê¸€-->
            <div id="recent" class="tab-content">
                <div class="section-content"></div>
            </div>

            <!--ë§ˆì´í¬ì¹´-->
            <div id="mypoca" class="tab-content">
                <div class="cards-header">
                    <button class="back-btn" onclick="showAlbumList()" style="display: none;">â† ì•¨ë²” ëª©ë¡ìœ¼ë¡œ</button>
                </div>
                
                <!-- ì•¨ë²” ëª©ë¡ ë·° -->
                <div class="section-content">
                    <div id="album-list" class="album-grid"></div>
                </div>

                
                <!-- í¬í† ì¹´ë“œ ëª©ë¡ ë·° (ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€)/ êµ¬í˜„ë°©ì•ˆ ê³ ë¯¼ì¤‘ -->
                <div id="photocard-list" style="display: none;">
                    <div id="current-album-title" class="current-album"></div>
                    <div class="section-content">
                        <div class="photocard-grid"></div>
                    </div>
                </div>

            </div>

            <!--ìœ„ì‹œë¦¬ìŠ¤íŠ¸-->
            <div id="wishlist" class="tab-content">
                <div class="section-content"></div>
            </div>

            <div id="transactions" class="tab-content">
                <div class="section-header">
                    <div class="transaction-tabs">
                        <button class="transaction-tab active" onclick="showTransactionTab('selling')">íŒë§¤ëª©ë¡</button>
                        <button class="transaction-tab" onclick="showTransactionTab('buying')">êµ¬ë§¤ëª©ë¡</button>
                        <button class="transaction-tab" onclick="showTransactionTab('exchange')">êµí™˜ëª©ë¡</button>
                    </div>
                </div>
                
                <div class="section-content">
                    <!--íŒë§¤ëª©ë¡-->
                    <div id="selling-list" class="transaction-content"></div>
                    <!--êµ¬ë§¤ëª©ë¡-->
                    <div id="buying-list" class="transaction-content" style="display: none;"></div>
                    <!--êµí™˜ëª©ë¡-->
                    <div id="exchange-list" class="transaction-content" style="display: none;"></div>
                </div>
            </div>

            <div id="reviews" class="tab-content">
                <div class="section-header">
                    <div class="review-tabs">
                        <button class="review-tab active" onclick="showReviewTab('received')">ë‚´ê°€ ë°›ì€ í›„ê¸°</button>
                        <button class="review-tab" onclick="showReviewTab('written')">ë‚´ê°€ ì“´ í›„ê¸°</button>
                    </div>
                </div>
                
                <!--ë‚´ê°€ ë°›ì€ ê±°ë˜ í›„ê¸°-->
                <div class="section-content">
                    <div id="received-reviews" class="review-content"></div>
                </div>

                <!--ë‚´ê°€ ì“´ í›„ê¸°-->
                <div class="section-content">
                    <div id="written-reviews" class="review-content" style="display: none;"></div>
                </div>
            </div>

            <div id="community" class="tab-content">
                <div class="section-header">
                    <div class="community-tabs">
                        <button class="community-tab active" onclick="showCommunityTab('WithU')">ë™í–‰</button>
                        <button class="community-tab " onclick="showCommunityTab('Sharing')">ë‚˜ëˆ”</button>
                        <button class="community-tab " onclick="showCommunityTab('Insteadbuy')">ëŒ€ë¦¬êµ¬ë§¤</button>
                        <button class="community-tab " onclick="showCommunityTab('shareNow')">í˜„í™©ê³µìœ </button>
                    </div>
                </div>

                <!--ë™í–‰ê¸€-->
                <div class="section-content">
                    <div id="WithU" class="community-content"></div> 
                </div>
                <!--ë‚˜ëˆ”ê¸€-->
                <div class="section-content">
                    <div id="Sharing" class="community-content" style="display: none;"></div> 
                </div>
                <!--ëŒ€ë¦¬êµ¬ë§¤-->
                <div class="section-content">
                    <div id="Insteadbuy" class="community-content" style="display: none;"></div> 
                </div>
                <!--í˜„í™©ê³µìœ -->
                <div class="section-content">
                    <div id="shareNow" class="community-content" style="display: none;"></div> 
                </div>
            </div>

            <!--ë¸”ë™ë¦¬ìŠ¤íŠ¸-->
            <div id="blocked" class="tab-content">
                <div class="section-header">
                    <div class="blocked-tabs">
                        <button class="blocked-tab active" onclick="showBlockedTab('blocked-user')">ë‚´ê°€ ì°¨ë‹¨í•œ ì‚¬ìš©ì</button>
                        <button class="blocked-tab" onclick="showBlockedTab('blocked-post')">ë‚´ê°€ ì‹ ê³ í•œ ê¸€</button>
                    </div>
                </div>

                <!--ì°¨ë‹¨í•œì‚¬ìš©ì-->
                <div class="section-content">
                    <div id="blocked-user" class="blocked-content"> </div>
                </div>

                <!--ì‹ ê³ í•œ ê¸€-->
                <div class="section-content">
                    <div id="blocked-post" class="blocked-content" style="display: none;"></div>
                </div>
            </div>
            <!--//ë¸”ë™ë¦¬ìŠ¤íŠ¸-->
        </div>
    </main>
    
<script>
    // íŒŒì¼ì—…ë¡œë“œ ê´€ë ¨
    const imageuploadContainer = document.getElementById('previous_container');
    const imageInput = document.getElementById('profile-img-input');
    const previewContainer = document.getElementById('previewContainer');
    const previewImage = document.getElementById('previewImage');
    const previousImage = document.getElementById('previousImage');

    imageuploadContainer.addEventListener('click',()=>imageInput.click());

    imageuploadContainer.addEventListener('dragover',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.add('dragover');
    });

    imageuploadContainer.addEventListener('dragleave',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.remove('dragover');
    });

    imageuploadContainer.addEventListener('drop',(e)=>{
        e.preventDefault();
        imageuploadContainer.classList.remove('dragover');
        const files = e.dataTransfer.files;
        if(files.length > 0 ){
            handleFile(files[0]);
        }
    });

    imageInput.addEventListener('change',(e)=>{
        if(e.target.files.length>0){
            handleFile(e.target.files[0]);
        }
    });

    // ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° í•¨ìˆ˜
    function handleFile(file) {
        if (file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = (e) => {
                previewImage.src = e.target.result;
                previewContainer.style.display = "block";
                previousImage.style.display = "none"; // ê¸°ì¡´ ì´ë¯¸ì§€ ìˆ¨ê¹€
            };
            reader.readAsDataURL(file);
        } else {
            alert("ì´ë¯¸ì§€ íŒŒì¼ë§Œ ì—…ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
    }

    // #Recent AJAX
    $.ajax({
        url: "/mypage/latest/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        success: function (data) {
            console.log('ìµœê·¼ ê²Œì‹œê¸€ ì—°ê²° ì„±ê³µ')

            const recentList = $("#recent .section-content");
            
            const cardsHtml = data.photocards.map(card => {
                const dateType = card.created_at.split('T')[0];

                return `
                    <a href="/photocard/detail/${ card.pno }">
                        <div class="item" data-pno="${ card.pno }">
                            <div>
                                <h3>${card.title}</h3>
                                <p>${dateType} - ${card.album}</p>
                            </div> 
                        </div>
                    </a>`}).join("");

            recentList.html(cardsHtml || "<div class='error-content'>ìµœê·¼ ë³¸ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
        },
        error: function () {
            console.error("ìµœê·¼ ë³¸ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            recentList.html("<div class='error-content'>ìµœê·¼ ë³¸ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });

    // #mypoca AJAX
    $.ajax({
        url: "/mypage/mypoca/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function (data) {
            console.log("ë°›ì€ ë°ì´í„°:", data.group_album_dict);

            const albumList = $("#mypoca #album-list");
            albumList.empty(); // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°

            const groupAlbumDict = data.group_album_dict;
            let hasPhotocards = false;  // í¬í† ì¹´ë“œ ì¡´ì¬ ì—¬ë¶€ ì²´í¬

            for (let groupName in groupAlbumDict) {
                const albumMap = groupAlbumDict[groupName];

                for (let albumName in albumMap) {
                    const photocards = albumMap[albumName];

                    if(!photocards || photocards.length === 0) continue;
                    hasPhotocards = true;

                    const firstCard = photocards[0]; // ëŒ€í‘œ ì´ë¯¸ì§€
                    const imageUrl = firstCard.image_url || '{/static/images/default.jpg}';
                    const cardCount = photocards.length;

                    const albumCard = `
                    <a href="/photocard/detail/${firstCard.pno}">
                        <div class="album-card" onclick="showPhotoCards('${groupName}-${albumName}')">
                            <div class="album-cover">
                                <img src="${imageUrl}" alt="${albumName}">
                            </div>
                            <div class="album-info">
                                <h4>${albumName}</h4>
                                <p>${groupName}</p>
                                <span class="card-count">${cardCount}ì¥</span>
                            </div>
                        </div>
                    </a>
                    `;

                    albumList.append(albumCard);
                }

            }
            // í¬í† ì¹´ë“œê°€ ì—†ëŠ” ê²½ìš°
            if(!hasPhotocards) {
                $("#mypoca .section-content").html("<div class='error-content'>ë³´ìœ í•œ í¬í† ì¹´ë“œê°€ ì—†ìŠµë‹ˆë‹¤.</div>");
            }            
        },
        error: function (xhr, status, error) {
            console.error("ë§ˆì´í¬ì¹´ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            $("#mypoca .section-content").html("<div class='error-content'>ë³´ìœ í•œ í¬í† ì¹´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });

    // #wishlist AJAX
    $.ajax({
        url: "/mypage/wishlist/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: 'json',
        success: function(data){
            console.log('ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ì—°ê²° ì„±ê³µ',data.wishlist);
            // ê¸°ì¡´ ëª©ë¡ ë¹„ìš°ê¸°
            const wishList = $("#wishlist .section-content");
            wishList.empty();

            const wishdata = data.wishlist.map(wish => 
                `<div class="item">
                    <a href="/photocard/detail/${wish.pno}">
                        <div class="wishlist">
                            <div class="wish-list-img">
                                <img src=${wish.image_url}>
                            </div>
                            <div class="wish-list-txt">
                                <span class="badge reserved">ê±°ë˜${wish.trade_state}</span>
                                <h3>${wish.title}
                                </h3>
                                <p>${wish.album}</p>
                            </div>
                        </div>
                    </a>
                </div>`).join("");
            wishList.append(wishdata || "<div class='error-content'>ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>")
        },
        error: function (xhr, status, error) {
            console.error("ìœ„ì‹œë¦¬ìŠ¤íŠ¸ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            wishList.html("<div class='error-content'>ìœ„ì‹œë¦¬ìŠ¤íŠ¸ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });

    // íŒë§¤ ëª©ë¡ AJAX
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('íŒë§¤ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

            const saleList = $("#transactions #selling-list");
            saleList.empty();

            const saleData = data.sell_poca.map(sell => 
                `<div class="item">
                <a href="/photocard/detail/${sell.pno}">
                    <h3>${sell.title}</h3>
                    <p>${sell.album} | ìƒíƒœ: ê±°ë˜${sell.trade_state}</p>
                </a>
                </div>`).join("");

            saleList.html(saleData||"<div class='error-content'>íŒë§¤ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
        }, error: function(xhr, status, error){
            console.error("íŒë§¤ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            saleList.html("<div class='error-content'>íŒë§¤ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });
    // êµ¬ë§¤ ëª©ë¡ AJAX
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('êµ¬ë§¤ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

            const buyList = $("#transactions #buying-list");
            buyList.empty();

            const buyData = data.buy_poca.map(buy => 
                `<div class="item">
                <a href="/photocard/detail/${buy.pno}">
                    <h3>${buy.title}</h3>
                    <p>${buy.album} | ìƒíƒœ: ê±°ë˜${buy.trade_state}</p>
                </a>
                </div>`).join("");
                buyList.html(buyData||"<div class='error-content'>êµ¬ë§¤ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>");

        }, error: function(xhr, status, error){
            console.error("íŒë§¤ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            buyList.html("<div class='error-content'>êµ¬ë§¤ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });
    // êµí™˜ ëª©ë¡ AJAX => ì‹¤ì œ êµí™˜ëª©ë¡ ë¦¬ìŠ¤íŠ¸ë¡œ ìˆ˜ì • í•„ìš”
    $.ajax({
        url: "/mypage/trade/",
        type: "POST",
        headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
        dataType: "json",
        success: function(data){
            console.log('êµí™˜ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

            const exchangeList = $("#transactions #exchange-list");
            exchangeList.empty();

            const exchangeData = data.exchange_poca.map(exchange => 
                `<div class="item">
                <a href="/photocard/detail/${exchange.pno}">
                    <h3>${exchange.title}</h3>
                    <p>${exchange.album} | ìƒíƒœ: ê±°ë˜${exchange.trade_state}</p>
                </a>
                </div>`).join("");

                exchangeList.html(exchangeData||"<div class='error-content'>êµí™˜ëª©ë¡ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
        }, error: function(xhr, status, error){
            console.error("êµí™˜ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
            exchangeList.html("<div class='error-content'>êµí™˜ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
        }
    });

    // ìœ ì €ì •ë³´ ê°€ì ¸ì˜¤ê¸°
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            break;
            }
        }
        }
        return cookieValue;
    }
        
        // ë‚´ê°€ ë°›ì€ í›„ê¸°ê¸€
        $.ajax({
            url: "/mypage/reviews/received/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ë°›ì€ í›„ê¸°ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const receivedList = $("#reviews #received-reviews");
                receivedList.empty();

                const receivedData = data.received_reviews.map(received => 
                    `<div class="item">
                    <a hred="/community/chgReview/view/${received.post_id}">
                        <h3>ì‘ì„±ì: ${received.writer}</h3>
                        <span class="rating">í‰ì  : ${received.overall_score}ì â­â­â­â­â­</span>
                        <p>${received.title} - ${received.content}</p>
                    </a>
                    </div>
                    `).join("");

                    receivedList.html(receivedData||"<div class='error-content'>ë°›ì€ í›„ê¸°ê¸€ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ë°›ì€ í›„ê¸°ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>ë°›ì€ í›„ê¸°ê¸€ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });
        // ë‚´ê°€ ì“´ í›„ê¸°ê¸€
        $.ajax({
            url: "/mypage/reviews/written/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ì“´ í›„ê¸°ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const writtenList = $("#reviews #written-reviews");
                writtenList.empty();

                const writtenData = data.written_reviews.map(written => 
                    `<div class="item">
                    <a hred="/community/chgReview/view/${written.post_id}">
                        <h3>ì œëª©: ${written.title} </h3>
                        <p>ì‘ì„±ì : ${written.partner__nickname}</p>
                        <p class="rating">í‰ì  : ${written.overall_score}â­â­â­â­â­</p>
                        <p class=".review-content">${written.content}</p>
                    </a>
                    </div>`).join("");

                    writtenList.html(writtenData||"<div class='error-content'>ì“´ í›„ê¸°ê¸€  ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ì“´ í›„ê¸°ê¸€  ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>ì“´ í›„ê¸°ê¸€  ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });

        // ì»¤ë®¤ë‹ˆí‹° - ë™í–‰ê¸€
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ë™í–‰ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const companionList = $("#community #WithU");
                companionList.empty();


                const companionData = data.companion.map(companion => {
                    `<div class="item">
                    <a href="/community/companion/view/">
                        <h3>${companion.title}</h3>
                        <p>${companion.created_at} - ì¡°íšŒìˆ˜: ${companion.views} | ëŒ“ê¸€: ${companion.comments_count}</p>
                    </a>
                    </div>
                    `}).join("");

                    companionList.html(companionData||"<div class='error-content'>ë™í–‰ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ë™í–‰ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>ë™í–‰ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });

        // ì»¤ë®¤ë‹ˆí‹° - ë‚˜ëˆ”ê¸€
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ë‚˜ëˆ”ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const sharingList = $("#community #Sharing");
                sharingList.empty();

                            
                const sharingData = data.sharing.map(sharing => {
                    `<div class="item">
                    <a href="/community/sharing/view/">
                        <h3>${sharing.title}</h3>
                        <p>${sharing.created_at} - ì¡°íšŒìˆ˜: ${sharing.views} | ëŒ“ê¸€: ${sharing.comments_count}</p>
                    </a>
                    </div>`}).join("");

                sharingList.html(sharingData||"<div class='error-content'>ë‚˜ëˆ”ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ë‚˜ëˆ”ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>ë‚˜ëˆ”ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });

        // ì»¤ë®¤ë‹ˆí‹° - ëŒ€ë¦¬êµ¬ë§¤
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ëŒ€ë¦¬êµ¬ë§¤ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const InsteadbuyList = $("#community #Insteadbuy");
                InsteadbuyList.empty();


                const InsteadbuyData = data.proxy.map(proxy => {
                    `<div class="item">
                    <a href="/community/proxy/view/">
                        <h3>${proxy.title}</h3>
                        <p>${proxy.created_at} - ì¡°íšŒìˆ˜: ${proxy.views} | ëŒ“ê¸€: ${proxy.comments_count}</p>
                    </a>
                    </div>
                    `}).join("");

                    InsteadbuyList.html(InsteadbuyData||"<div class='error-content'>ëŒ€ë¦¬êµ¬ë§¤ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ëŒ€ë¦¬êµ¬ë§¤ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>ëŒ€ë¦¬êµ¬ë§¤ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });
        // ì»¤ë®¤ë‹ˆí‹° - í˜„í™©ê³µìœ 
        /*
        $.ajax({
            url: "/mypage/review/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('í˜„í™©ê³µìœ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const shareNowList = $("#community #shareNow");
                shareNowList.empty();


                const shareNowData = data.shareNow.map(shareNow => {
                    `<div class="item">
                        <h3>${shareNow.title}</h3>
                        <p>${shareNow.created_at} - ì¡°íšŒìˆ˜: ${shareNow.views} | ëŒ“ê¸€: ${shareNow.comments_count}</p>
                    </div>`}).join("");

                    shareNowList.html(shareNowData||"<div class='error-content'>í˜„í™©ê³µìœ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("í˜„í™©ê³µìœ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨");
                $("#reviews #received-reviews").html("<div class='error-content'>í˜„í™©ê³µìœ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });
        */

    // ë¸”ë™ë¦¬ìŠ¤íŠ¸ - ì°¨ë‹¨í•œ ì‚¬ìš©ì ëª©ë¡ AJAX
    function loadBlockedUsers() {
        $.ajax({
            url: "/mypage/blocklist/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ì°¨ë‹¨ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const blockuserList = $("#blocked #blocked-user");
                blockuserList.empty();

                const blockData = data.blocked_users.map(user => 
                    `<div class="item" data-user-id="${user.user_id}">
                        <h3>${user.user_id} - ${user.name}</h3>
                        <button class="unblock-btn" data-user-id="${user.user_id}">ì°¨ë‹¨í•´ì œ</button>
                        <p>ì°¨ë‹¨ ì‚¬ìœ : ${user.reason}</p>
                    </div>`).join("");

                blockuserList.append(blockData||"<div class='error-content'>ì°¨ë‹¨ ì‚¬ìš©ì ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ì°¨ë‹¨ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",xhr,status,error);
                blockuserList.html("<div class='error-content'>ì°¨ë‹¨ ì‚¬ìš©ì ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });
    };

    // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì—ëŠ” ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì‚¬ìš©
    $(document).on("click", ".unblock-btn", function () {
        const $item = $(this).closest('.item');
        const userId = $item.data('user-id');

        if (!confirm("ì •ë§ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        $.ajax({
            url: '/mypage/update_blocklist/',  // URLì€ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •
            type: 'POST',
            data: JSON.stringify({ id: userId }),  // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
            contentType: 'application/json',
            headers: {
            'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                showToast('ì°¨ë‹¨í•´ì œê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadBlockedUsers();
            },
            error: function(xhr) {
                $('#result').text('ì˜¤ë¥˜: ' + (xhr.responseJSON?.error || xhr.responseJSON?.message || 'ìš”ì²­ ì‹¤íŒ¨'));
                    console.log('error')
            }
        });
    });

    $(document).ready(function(){
        loadBlockedUsers();
    });

    /*
    // ë¸”ë™ë¦¬ìŠ¤íŠ¸ - ì‹ ê³ í•œ ê¸€ ëª©ë¡ AJAX
    function loadBlockedPosts() {
        $.ajax({
            url: "/mypage/blocklist/",
            type: "POST",
            headers: { "X-CSRFToken": $('meta[name="csrf-token"]').attr('content') },
            dataType: "json",
            success: function(data){
                console.log('ì‹ ê³ í•œ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì„±ê³µ');

                const blockpostList = $("#blocked #blocked-post");
                blockpostList.empty();

                const blockpostData = data.blocked_post.map(post => 
                    `<div class="item" data-user-id="${post.user_id}">
                        <h3>${post.user_id} - ${post.name}</h3>
                        <button class="unblock-btn post" data-user-id="${post.user_id}">ì°¨ë‹¨í•´ì œ</button>
                        <p>ì°¨ë‹¨ ì‚¬ìœ : ${post.reason}</p>
                    </div>`).join("");

                blockpostList.append(blockpostData||"<div class='error-content'>ì‹ ê³ í•œ ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</div>");
            }, error: function(xhr, status, error){
                console.error("ì‹ ê³ í•œ ê¸€ ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨",xhr,status,error);
                blockpostList.html("<div class='error-content'>ì‹ ê³ í•œ ê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>");
            }
        });
    };

    // ë™ì ìœ¼ë¡œ ìƒì„±ëœ ìš”ì†Œì—ëŠ” ì´ë²¤íŠ¸ ìœ„ì„ ë°©ì‹ ì‚¬ìš©
    $(document).on("click", ".unblock-btn post", function () {
        const $item = $(this).closest('.item');
        const userId = $item.data('user-id');

        if (!confirm("ì •ë§ ì°¨ë‹¨ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

        $.ajax({
            url: '/mypage/update_blocklist/',  // URLì€ ì‹¤ì œ í”„ë¡œì íŠ¸ì— ë§ê²Œ ìˆ˜ì •
            type: 'POST',
            data: JSON.stringify({ id: userId }),  // JSON í˜•ì‹ìœ¼ë¡œ ì „ì†¡
            contentType: 'application/json',
            headers: {
            'X-CSRFToken': getCookie('csrftoken')
            },
            success: function(response) {
                showToast('ì°¨ë‹¨í•´ì œê°€ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
                loadBlockedUsers();
            },
            error: function(xhr) {
                $('#result').text('ì˜¤ë¥˜: ' + (xhr.responseJSON?.error || xhr.responseJSON?.message || 'ìš”ì²­ ì‹¤íŒ¨'));
                    console.log('error')
            }
        });
    });

    $(document).ready(function(){
        loadBlockedUsers();
    });
    */
    
    // í”„ë¡œí•„ ìˆ˜ì • ì—…ë°ì´íŠ¸ AJAX
    $('#profileForm').on('submit', function(e) {
        e.preventDefault();

        const formData = new FormData(this);

        $.ajax({
            url: '/mypage/update_profile/',
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            headers: {
            'X-CSRFToken': getCookie('csrftoken')  // CSRF í† í° í•„ìš”
            },
            success: function(response) {
                alert("í”„ë¡œí•„ ìˆ˜ì • ì„±ê³µ");
            },
            error: function(xhr) {
                alert('ì˜¤ë¥˜: ' + xhr.responseJSON?.message || 'ìš”ì²­ ì‹¤íŒ¨');
            }
        });
    });


    // ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰ ëª¨ë‹¬ì°½
    document.addEventListener("DOMContentLoaded", () => {
        const modal = document.getElementById('searchModal');
        const searchModalOpen = document.getElementById('searchModalOpen');
        const searchModalClose = document.getElementById('searchModalOpenClose');
        const searchInput = document.getElementById('idolSearch');
        const completeBtn = document.getElementById('completeBtn');
        const groupsContainer = document.getElementById('groupsContainer');
        const searchNotice = document.getElementById('searchNotice');
        const hiddenInputsContainer = document.getElementById('hiddenInputsContainer');
        const memberGrid = document.querySelector('.mybias_input');

        let selectedMembers = new Set();
        let currentFilter = 'all';
        
        const mybiasInput = document.querySelector(".mybias_input");
        mybiasInput.addEventListener("click", () => {
            searchModal.style.display = "block";

            // ê²€ìƒ‰ ì´ˆê¸°í™”
            searchInput.value = '';
            searchInput.focus();
            groupsContainer.innerHTML = '';
            searchNotice.style.display = 'block';
            selectedMember = null;
            completeBtn.disabled = true;

        });  
        
        // ëª¨ë‹¬ ë‹«ê¸°
        searchModalClose.addEventListener('click', () => {
            modal.style.display = 'none';
        });

        window.addEventListener('click', e => {
            if (e.target === modal) modal.style.display = 'none';
        });

        // ì„ íƒëœ ë©¤ë²„ ì—…ë°ì´íŠ¸
        function updateSelectedDisplay() {
            const count = document.getElementById('selectedCount');
            const container = document.getElementById('selectedMembers');
            const list = document.getElementById('selectedList');
            count.textContent = selectedMembers.size;

            if (selectedMembers.size === 0) {
            container.style.display = 'none';
            completeBtn.disabled = true;
            } else {
            container.style.display = 'block';
            completeBtn.disabled = false;
            list.innerHTML = Array.from(selectedMembers).map(item => {
                const [group, member] = item.split('-');
                return `
                <div class="selected-item">
                    <span>${group} - ${member}</span>
                    <button class="remove-btn" data-item="${item}">Ã—</button>
                </div>
                `;
            }).join('');
            }
        }

        // ì„ íƒëœ ë©¤ë²„ ì·¨ì†Œ 
        groupsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('remove-btn')) {
                const item = e.target.dataset.item;
                selectedMembers.delete(item);
                updateSelectedDisplay();
                // ë²„íŠ¼ì—ì„œ selected í´ë˜ìŠ¤ ì œê±°
                document.querySelectorAll('.member-toggle').forEach(btn => {
                    const key = `${btn.dataset.group}-${btn.dataset.member}`;
                    if (key === item) {
                        btn.classList.remove('selected');
                    }
                });
            }
        });

        // ê²€ìƒ‰ ì²˜ë¦¬
        searchInput.addEventListener('input', () => {
            const query = searchInput.value.trim();
            if (!query) {
                groupsContainer.innerHTML = '';
                searchNotice.style.display = 'block';
                return;
            }

            // api query
            fetch(`/idols/search/?q=${query}`)
                .then(res => res.json())
                .then(data => {
                    groupsContainer.innerHTML = '';
                    searchNotice.style.display = 'none';
                    completeBtn.disabled = true;


                    // ê²€ìƒ‰ëœ ê²°ê³¼ê°€ ì—¬ëŸ¬ëª… ê²½ìš°
                    const groups = {};
                    data.members.forEach(m => {
                        const group = m.group__name;
                        if (!groups[group]) {
                            groups[group] = { gender: m.group__gender, members: [] };
                        }
                        groups[group].members.push(m);
                    });

                    Object.entries(groups).forEach(([groupName, info]) => {
                        const groupCard = document.createElement('div');
                        groupCard.className = 'group-card';
                        const typeClass = info.gender === "M" ? "boy-group" : "girl-group";

                        groupCard.innerHTML = `
                            <div class="group-header">
                                <div class="group-name">${groupName}</div>
                                <div class="group-type ${typeClass}">
                                    ${info.gender === "M" ? "ë³´ì´ê·¸ë£¹" : "ê±¸ê·¸ë£¹"}
                                </div>
                            </div>
                            <div class="members-grid">
                                ${info.members.map(member => {
                                    const isSelected = selectedMember && selectedMember.group === groupName && selectedMember.member === member.name;
                                    return `
                                        <button type="button" class="member-toggle ${isSelected ? 'selected' : ''}"
                                            data-group="${groupName}" data-member="${member.name}">
                                            ${member.name}
                                        </button>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        groupsContainer.appendChild(groupCard);
                    });
                });
        });

        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('member-toggle') && !e.target.classList.contains('disabled')) {
            const group = e.target.dataset.group;
            const member = e.target.dataset.member;
            const key = `${group}-${member}`;

            if (selectedMembers.has(key)) {
                selectedMembers.delete(key);
                e.target.classList.remove('selected');
            } else {
                if (selectedMembers.size < 2) {
                selectedMembers.add(key);
                e.target.classList.add('selected');
                }
            }

            updateSelectedDisplay();
            }

            if (e.target.classList.contains('remove-btn')) {
            const item = e.target.dataset.item;
            selectedMembers.delete(item);
            updateSelectedDisplay();
            document.getElementById("idolSearch").dispatchEvent(new Event("input"));
            }
        });

        // ì™„ë£Œ ë²„íŠ¼ í´ë¦­
        completeBtn.addEventListener('click', () => {
            if (selectedMembers.size === 0) return;
            
            // hidden input, ë Œë”ë§ ì´ˆê¸°í™”
            hiddenInputsContainer.innerHTML = '';
            memberGrid.innerHTML = '';

            // ì„ íƒëœ ë©¤ë²„ ìˆœì„œëŒ€ë¡œ ë¶„ë¦¬
            const selectedArray = Array.from(selectedMembers);
            selectedArray.forEach((item, index) => {
                const [group, member] = item.split('-');

                // hidden input ìƒì„± (favorite, second êµ¬ë¶„)
                const groupInputName = index === 0 ? 'favorite_group' : 'second_group';
                const memberInputName = index === 0 ? 'favorite_member' : 'second_member';

                hiddenInputsContainer.innerHTML += `
                    <input type="hidden" name="${groupInputName}" value="${group}">
                    <input type="hidden" name="${memberInputName}" value="${member}">
                `;

                // ë©”ì¸ ì…ë ¥ í•„ë“œ ë Œë”ë§
                memberGrid.innerHTML += `
                    <input type="text" name="mybias" value="${group} - ${member}" readonly style="cursor: pointer;">
                `;
            });

            // ëª¨ë‹¬ ë‹«ê¸°
            modal.style.display = 'none';
        });

        // í•„í„° ë²„íŠ¼ ì²˜ë¦¬
        document.querySelectorAll('.filter-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentFilter = btn.dataset.filter;
                searchInput.dispatchEvent(new Event('input'));
            });
        });

    });

</script>

{%endblock%}
<!--//ìƒë‹¨í—¤ë”-->

</body>
</html>