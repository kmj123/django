{% extends 'header_login.html'%}
{% load static %}
<!--ìƒë‹¨ í—¤ë”-->
{%block content%}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>í¬ì¹´ê¾¸ë¯¸ê¸° - PO-PIN</title>
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link rel="stylesheet" type="text/css" href="{% static 'css/pocadeco/main.css' %}" />
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">í¬í† ì¹´ë“œ ê¾¸ë¯¸ê¸°</h1>
                    <button class="decolist" onclick="location.href='/pocadeco/decolist/'">ğŸ’¬ í¬ê¾¸ ê²Œì‹œíŒ</button>
            </div>

            <div class="editor-layout">
                <div class="editor-main">
                    <div class="canvas-container">
                        <div class="canvas-area" id="canvasArea">
                            <div class="canvas-placeholder" id="placeholder">
                                <i>ğŸ“·</i>
                                <div>í¬í† ì¹´ë“œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                                <small>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</small>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" />
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="resetEditor()">ì´ˆê¸°í™”</button>
                        <button class="btn btn-primary" onclick="saveDecoration()">ì €ì¥í•˜ê¸°</button>
                        <button class="btn btn-success" onclick="downloadImage()">ë‹¤ìš´ë¡œë“œ</button>
                    </div>

                    <div class="gallery-section"> {# ê¸°ì¡´ style="margin-top: 40px;" ëŒ€ì‹  ìƒˆë¡œìš´ í´ë˜ìŠ¤ ì¶”ê°€ #}
                        <div class="gallery-header">
                            <h2>ë‚´ í¬ê¾¸ ê°¤ëŸ¬ë¦¬</h2>
                            <button class="add-photo-btn" onclick="addToGallery()">
                                <span>ğŸ“·</span> ì‚¬ì§„ ì¶”ê°€
                            </button>
                        </div>
                        <input type="file" id="galleryInput" accept="image/*" />
                        <div class="gallery-grid" id="myGallery">
                            {%for mydeco in mydecolist%}
                            <div class="gallery-item" data-id="{{ mydeco.id }}">
                                <img src="/media/{{mydeco.result_image}}" alt="New Jeans Hanni" />
                                <div class="gallery-info">
                                    <div class="gallery-title">{{mydeco.title}}</div>
                                    <div class="gallery-date">{{mydeco.date}}</div>
                                </div>
                                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
                            </div>
                            {%endfor%}
                        </div>
                    </div>
                </div>

              <div class="editor-sidebar panel"> 
                <div id="searchNotice" style="display: none;"></div>

<form id="memberForm" method="POST">
  {% csrf_token %}
  <div id="hiddenInputsContainer"></div>
</form>
    <div class="tool-section">
        <h3>ë©¤ë²„ ì„ íƒ</h3>
        <div id="selectedMembers">
        <div id="selectedList"></div>
        </div>

        <div class="search-container">
            <input type="text" class="search-box" placeholder="ê·¸ë£¹ëª… ë˜ëŠ” ë©¤ë²„ëª…ìœ¼ë¡œ ê²€ìƒ‰..." id="idolSearch">
            <div class="filter-buttons">
                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">ì „ì²´</button>
                    <button type="button" class="filter-btn" data-filter="boy">ë³´ì´ê·¸ë£¹</button>
                    <button type="button" class="filter-btn" data-filter="girl">ê±¸ê·¸ë£¹</button>
             </div>
            </div>
        </div>
        
        <div class="groups-container" id="groupsContainer"></div>
        <div id="hiddenInputsContainer"></div>
    </div>
    <div class="tool-section">
        <h3>í”„ë ˆì„</h3>
        <div class="frame-grid">
            <div class="frame-option" data-frame="vintage" onclick="selectFrame('vintage')">
                <div class="frame-preview vintage"></div>
            </div>
            <div class="frame-option" data-frame="polaroid" onclick="selectFrame('polaroid')">
                <div class="frame-preview polaroid"></div>
            </div>
            <div class="frame-option" data-frame="flower" onclick="selectFrame('flower')">
                <div class="flower-decoration">ğŸŒ¸</div>
            </div>
            <div class="frame-option" data-frame="rainbow" onclick="selectFrame('rainbow')">
                <div class="rainbow-decoration">ğŸŒˆ</div>
            </div>
            <div class="frame-option" data-frame="heart" onclick="selectFrame('heart')">
                <div class="heart-decoration">ğŸ’–</div>
            </div>
            <div class="frame-option" data-frame="gold" onclick="selectFrame('gold')">
                <div class="frame-preview gold"></div>
            </div>
        </div>
    </div>

    <div class="tool-section">
        <h3>í…ìŠ¤íŠ¸ ì…ë ¥</h3>
        <div class="text-input-group">
            <select id="fontSelect">
                <option value="Nanum Gothic, sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
                <option value="Noto Sans KR, sans-serif">ë³¸ê³ ë”•</option>
                <option value="Arial, sans-serif">Arial</option>
                <option value="Verdana, sans-serif">Verdana</option>
                <option value="Georgia, serif">Georgia</option>
                <option value="Times New Roman, serif">Times New Roman</option>
            </select>
            <label for="fontSelect" style="display: none;">ê¸€ê¼´ ì„ íƒ</label>
        </div>
        <div class="text-input-group">
            <input type="text" id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
        </div>
        <div class="add-text-button-container">
            <button class="btn btn-primary" id="addTextBtn">í…ìŠ¤íŠ¸ ì¶”ê°€</button>
        </div>
    </div>

    <div class="tool-section">
        <h3>ìŠ¤í‹°ì»¤</h3>
        <div class="sticker-grid">
            <div class="sticker-btn" data-sticker="ğŸ’–">ğŸ’–</div>
            <div class="sticker-btn" data-sticker="â­">â­</div>
            <div class="sticker-btn" data-sticker="âœ¨">âœ¨</div>
            <div class="sticker-btn" data-sticker="ğŸ’­">ğŸ’­</div>
            <div class="sticker-btn" data-sticker="ğŸ’¤">ğŸ’¤</div>
            <div class="sticker-btn" data-sticker="ğŸ’¢">ğŸ’¢</div>
            <div class="sticker-btn" data-sticker="ğŸ’«">ğŸ’«</div>
            <div class="sticker-btn" data-sticker="ğŸ¹">ğŸ¹</div>
        </div>
    </div>
</div>
<script>
    let selectedMember = null;
let currentFilter = 'all';
let activeDraggable = null;
let isSelectionLocked = false; // ì„ íƒ ê³ ì • ìƒíƒœ ì¶”ê°€

// DOM ë¡œë“œ ì™„ë£Œ ì‹œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
document.addEventListener('DOMContentLoaded', function() {
    // íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', handleFileSelect);
    }

    // ê°¤ëŸ¬ë¦¬ ì¶”ê°€ ì´ë²¤íŠ¸
    const galleryInput = document.getElementById('galleryInput');
    if (galleryInput) {
        galleryInput.addEventListener('change', handleGalleryAdd);
    }

    // í…ìŠ¤íŠ¸ ì¶”ê°€ ë²„íŠ¼ ì´ë²¤íŠ¸
    const addTextBtn = document.getElementById('addTextBtn');
    if (addTextBtn) {
        addTextBtn.addEventListener('click', addText);
    }

    // ìŠ¤í‹°ì»¤ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.sticker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            addSticker(btn.dataset.sticker);
        });
    });

    // í”„ë ˆì„ ì˜µì…˜ ì´ë²¤íŠ¸
    document.querySelectorAll('.frame-option').forEach(option => {
        option.addEventListener('click', function() {
            const frame = this.dataset.frame;
            if (frame) {
                applyFrame(frame);
            }
        });
    });

    // í”Œë ˆì´ìŠ¤í™€ë” í´ë¦­ ì´ë²¤íŠ¸
    const placeholder = document.getElementById('placeholder');
    if (placeholder) {
        placeholder.addEventListener('click', uploadPhoto);
    }

    // ìº”ë²„ìŠ¤ ë“œë˜ê·¸ ë°©ì§€
    const canvas = document.getElementById('canvasArea');
    if (canvas) {
        canvas.addEventListener('dragstart', e => e.preventDefault());
    }

    // ë©¤ë²„ ê²€ìƒ‰ ì´ë²¤íŠ¸
    const idolSearch = document.getElementById("idolSearch");
    if (idolSearch) {
        idolSearch.addEventListener("input", handleSearch);
    }

    // í•„í„° ë²„íŠ¼ ì´ë²¤íŠ¸
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.addEventListener('click', handleFilterClick);
    });

    // ë©¤ë²„ ì„ íƒ ë° ì œê±° ì´ë²¤íŠ¸ (ì´ë²¤íŠ¸ ìœ„ì„)
    document.addEventListener('click', handleMemberActions);

    // ì´ˆê¸° ìƒíƒœ ì„¤ì •
    updateSelectedDisplay();
    updateSelectionUI();
});

// íŒŒì¼ ì—…ë¡œë“œ í•¨ìˆ˜
function uploadPhoto() {
    const canvas = document.getElementById('canvasArea');
    const existingPhoto = canvas.querySelector('.photo-preview');
    if (existingPhoto) {
        return;
    }
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.click();
    }
}

// íŒŒì¼ ì„ íƒ ì²˜ë¦¬
function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            const canvas = document.getElementById('canvasArea');
            if (canvas) {
                canvas.innerHTML = '';
                canvas.style.border = '3px dashed #ddd';
                
                const img = document.createElement('img');
                img.src = e.target.result;
                img.className = 'photo-preview';
                img.id = 'uploadedPhoto';
                canvas.appendChild(img);
                
                // í”„ë ˆì„ ì„ íƒ ì´ˆê¸°í™”
                document.querySelectorAll('.frame-option').forEach(option => {
                    option.classList.remove('active');
                });

                // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ˆê¸°í™”
                const textInput = document.getElementById('textInput');
                if (textInput) {
                    textInput.value = '';
                }
            }
        };
        reader.readAsDataURL(file);
    }
}

// ì—ë””í„° ì´ˆê¸°í™”
function resetEditor() {
    const canvas = document.getElementById('canvasArea');
    if (canvas) {
        canvas.innerHTML = `
            <div class="canvas-placeholder" id="placeholder">
                <i>ğŸ“·</i>
                <div>í¬í† ì¹´ë“œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                <small>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</small>
            </div>
        `;
        canvas.style.border = '3px dashed #ddd';
    }

    // í”„ë ˆì„ ì„ íƒ ì´ˆê¸°í™”
    document.querySelectorAll('.frame-option').forEach(option => {
        option.classList.remove('active');
    });

    // í…ìŠ¤íŠ¸ ì…ë ¥ ì´ˆê¸°í™”
    const textInput = document.getElementById('textInput');
    if (textInput) {
        textInput.value = '';
    }

    // í”Œë ˆì´ìŠ¤í™€ë” ì´ë²¤íŠ¸ ì¬ë“±ë¡
    const placeholder = document.getElementById('placeholder');
    if (placeholder) {
        placeholder.addEventListener('click', uploadPhoto);
    }
}

// ê¾¸ë¯¸ê¸° ì €ì¥
function saveDecoration() {
    const canvasEl = document.getElementById('canvasArea');
    if (!canvasEl) return;

    const title = prompt("í¬ê¾¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
    if (!title) return;

    // html2canvasê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (typeof html2canvas === 'undefined') {
        alert('html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    html2canvas(canvasEl, {
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        scale: 2,
    }).then(canvas => {
        const dataUrl = canvas.toDataURL("image/png");
        const gallery = document.getElementById('myGallery');

        // ì„œë²„ì— ë°ì´í„° ì „ì†¡
        fetch('/pocadeco/save_decopoca/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({
                title: title,
                image: dataUrl,
                group: "ì•„ì¼ë¦¿", // ì„ì‹œ ê·¸ë£¹ ë©¤ë²„ í•˜ë“œì½”ë”© (ìˆ˜ì •í•´ì£¼ì„¸ìš”!!)
                member: "ëª¨ì¹´",
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const gallery = document.getElementById('myGallery');
                if (gallery) {
                    const now = new Date().toISOString().split('T')[0];
                    const item = document.createElement('div');
                    item.className = 'gallery-item';
                    item.setAttribute('data-id', data.id);  // ì—¬ê¸°ì„œ ì„œë²„ ì‘ë‹µ id ì‚¬ìš©

                    item.innerHTML = `
                        <img src="${data.result_image}" alt="${data.title}" />
                        <div class="gallery-info">
                            <div class="gallery-title" ondblclick="makeTitleEditable(this.parentElement)">${data.title}</div>
                            <div class="gallery-date">${now}</div>
                        </div>
                        <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
                    `;
                    gallery.prepend(item);
                }

                console.log('ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
            } else {
                alert('ì„œë²„ ì €ì¥ ì‹¤íŒ¨: ' + data.reason);
            }
        })
        .catch(error => {
            console.error('ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì„œë²„ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });

    }).catch(error => {
        console.error('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ
function downloadImage() {
    const canvasEl = document.getElementById('canvasArea');
    if (!canvasEl) return;

    // html2canvasê°€ ë¡œë“œë˜ì–´ ìˆëŠ”ì§€ í™•ì¸
    if (typeof html2canvas === 'undefined') {
        alert('html2canvas ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
        return;
    }

    html2canvas(canvasEl, {
        useCORS: true,
        allowTaint: true,
        backgroundColor: null,
        scale: 2,
    }).then(canvas => {
        const link = document.createElement('a');
        link.download = 'photocard-' + new Date().getTime() + '.png';
        link.href = canvas.toDataURL();
        link.click();
    }).catch(error => {
        console.error('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤:', error);
        alert('ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
    });
}

// ê°¤ëŸ¬ë¦¬ì— ì‚¬ì§„ ì¶”ê°€
function addToGallery() {
    const galleryInput = document.getElementById('galleryInput');
    if (galleryInput) {
        galleryInput.click();
    }
}

// ê°¤ëŸ¬ë¦¬ ì¶”ê°€ ì²˜ë¦¬
function handleGalleryAdd(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        const gallery = document.getElementById('myGallery');
        if (gallery) {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            const now = new Date().toISOString().split('T')[0];

            item.innerHTML = `
                <img src="${e.target.result}" alt="ì¶”ê°€ëœ ì´ë¯¸ì§€" />
                <div class="gallery-info">
                    <div class="gallery-title" ondblclick="makeTitleEditable(this.parentElement)">ì¶”ê°€ëœ ì´ë¯¸ì§€</div>
                    <div class="gallery-date">${now}</div>
                </div>
                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
            `;
            gallery.prepend(item);
        }
    };
    reader.readAsDataURL(file);
}

// ê°¤ëŸ¬ë¦¬ ì•„ì´í…œ ì‚­ì œ
function deleteGalleryItem(btn) {
    const itemEl = btn.closest('.gallery-item');  // ê°€ì¥ ê°€ê¹Œìš´ gallery-item div
    const decoid = itemEl.getAttribute('data-id');

    if (!decoid) {
        alert('ì‚­ì œí•  IDë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    if (confirm("ì´ í¬í† ì¹´ë“œë¥¼ ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        // ì„œë²„ì— ë°ì´í„° ì „ì†¡
        fetch('/pocadeco/delete_decopoca/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken,
            },
            body: JSON.stringify({ id: decoid })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                console.log(data.message);
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜:', error);
            alert('ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });

        btn.parentElement.remove();
    }
}

// ì œëª© í¸ì§‘ ê°€ëŠ¥í•˜ê²Œ ë§Œë“¤ê¸°
function makeTitleEditable(element) {
    const title = element.querySelector('.gallery-title');
    if (title) {
        title.setAttribute('contenteditable', true);
        title.focus();
        title.onblur = () => {
            title.removeAttribute('contenteditable');
        };
        title.onkeydown = (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                title.blur();
            }
        };
    }
}

// í”„ë ˆì„ ì ìš©
function applyFrame(styleName) {
    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    // ê¸°ì¡´ í”„ë ˆì„ ì œê±°
    const existingFrame = canvas.querySelector('.frame-effect');
    if (existingFrame) {
        existingFrame.remove();
    }

    // ìƒˆ í”„ë ˆì„ ì¶”ê°€
    const frame = document.createElement('div');
    frame.className = `frame-effect ${styleName}`;
    canvas.appendChild(frame);

    // í”„ë ˆì„ ì„ íƒ ìƒíƒœ ì—…ë°ì´íŠ¸
    document.querySelectorAll('.frame-option').forEach(option => {
        option.classList.remove('active');
    });
    
    const selectedFrame = document.querySelector(`[data-frame="${styleName}"]`);
    if (selectedFrame) {
        selectedFrame.classList.add('active');
    }
}

// í”„ë ˆì„ ì„ íƒ (ë³„ë„ í•¨ìˆ˜ë¡œ ë¶„ë¦¬)
function selectFrame(styleName) {
    applyFrame(styleName);
}

// ë“œë˜ê·¸ ë° ë¦¬ì‚¬ì´ì¦ˆ ê¸°ëŠ¥
function makeDraggableAndResizable(element) {
    const canvas = document.getElementById('canvasArea');
    const resizeHandle = element.querySelector('.sticker-resize-handle');

    let isDragging = false;
    let isResizing = false;
    let offsetX = 0, offsetY = 0;
    let initialWidth, initialHeight, initialX, initialY, initialFontSize;

    element.onmousedown = function(e) {
        e.stopPropagation();
        activeDraggable = element;

        if (e.target === resizeHandle) {
            isResizing = true;
            initialX = e.clientX;
            initialY = e.clientY;
            initialWidth = element.offsetWidth;
            initialHeight = element.offsetHeight;
            initialFontSize = parseFloat(window.getComputedStyle(element).fontSize);
            element.style.cursor = 'nwse-resize';
            document.body.style.cursor = 'nwse-resize';
        } else {
            isDragging = true;
            const rect = element.getBoundingClientRect();
            offsetX = e.clientX - rect.left;
            offsetY = e.clientY - rect.top;
            element.style.cursor = 'grabbing';
            document.body.style.cursor = 'grabbing';
        }
        element.style.zIndex = 1000;
    };

    element.onmouseover = function() {
        if (!isDragging && !isResizing) {
            element.style.cursor = 'grab';
        }
    };

    element.onmouseout = function() {
        if (!isDragging && !isResizing) {
            element.style.cursor = '';
        }
    };

    element.ondblclick = function(e) {
        e.stopPropagation();
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            element.remove();
        }
    };

    // ì „ì—­ ë§ˆìš°ìŠ¤ ì´ë²¤íŠ¸
    document.onmousemove = function(e) {
        if (!activeDraggable) return;

        const canvasRect = canvas.getBoundingClientRect();
        
        if (isDragging) {
            let newLeft = e.clientX - canvasRect.left - offsetX;
            let newTop = e.clientY - canvasRect.top - offsetY;

            newLeft = Math.max(0, Math.min(newLeft, canvasRect.width - element.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, canvasRect.height - element.offsetHeight));

            element.style.left = newLeft + 'px';
            element.style.top = newTop + 'px';
        } else if (isResizing) {
            const deltaX = e.clientX - initialX;
            const deltaY = e.clientY - initialY;

            let newFontSize;
            if (initialWidth > 0 && initialHeight > 0) {
                const ratioX = (initialWidth + deltaX) / initialWidth;
                const ratioY = (initialHeight + deltaY) / initialHeight;
                newFontSize = initialFontSize * Math.max(ratioX, ratioY);
            } else {
                newFontSize = initialFontSize + Math.max(deltaX, deltaY);
            }

            newFontSize = Math.max(12, newFontSize);
            const maxAllowedFontSize = Math.min(canvasRect.width, canvasRect.height) * 0.3;
            newFontSize = Math.min(newFontSize, maxAllowedFontSize);

            element.style.fontSize = newFontSize + 'px';
        }
    };

    document.onmouseup = function() {
        isDragging = false;
        isResizing = false;
        if (activeDraggable) {
            activeDraggable.style.zIndex = 50;
            activeDraggable.style.cursor = 'grab';
        }
        document.body.style.cursor = 'default';
        activeDraggable = null;
    };
}

// ìŠ¤í‹°ì»¤ ì¶”ê°€
function addSticker(emoji) {
    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    const sticker = document.createElement('div');
    sticker.className = 'sticker-overlay';
    sticker.textContent = emoji;

    const canvasRect = canvas.getBoundingClientRect();
    sticker.style.left = `${(canvasRect.width / 2) - 15}px`;
    sticker.style.top = `${(canvasRect.height / 2) - 15}px`;
    sticker.style.position = 'absolute';

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'sticker-resize-handle';
    sticker.appendChild(resizeHandle);

    canvas.appendChild(sticker);
    makeDraggableAndResizable(sticker);

    document.body.style.cursor = 'default';
}

// í…ìŠ¤íŠ¸ ì¶”ê°€
function addText() {
    const textInput = document.getElementById('textInput');
    const textContent = textInput.value.trim();

    if (!textContent) {
        alert('ì…ë ¥í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    const textElement = document.createElement('div');
    textElement.className = 'text-overlay';
    textElement.textContent = textContent;

    const fontSelect = document.getElementById('fontSelect');
    const selectedFont = fontSelect ? fontSelect.value : 'Arial, sans-serif';
    textElement.style.fontFamily = selectedFont;

    const canvasRect = canvas.getBoundingClientRect();
    textElement.style.left = `${(canvasRect.width / 2) - 50}px`;
    textElement.style.top = `${(canvasRect.height / 2) - 15}px`;
    textElement.style.position = 'absolute';
    textElement.style.color = 'black';

    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'sticker-resize-handle';
    textElement.appendChild(resizeHandle);

    canvas.appendChild(textElement);
    makeDraggableAndResizable(textElement);

    textInput.value = '';
    document.body.style.cursor = 'default';
}

// ë©¤ë²„ ê²€ìƒ‰ ì²˜ë¦¬
function handleSearch() {
    const query = this.value.trim();
    const container = document.getElementById("groupsContainer");
    const searchNotice = document.getElementById("searchNotice");

    if (!query) {
        if (container) container.innerHTML = '';
        if (searchNotice) searchNotice.style.display = 'block';
        return;
    }

    if (searchNotice) searchNotice.style.display = 'none';

    // ëª© ë°ì´í„° (ì‹¤ì œë¡œëŠ” ì„œë²„ API í˜¸ì¶œ)
    const mockData = {
        members: [
            { name: "ì •êµ­", group__name: "BTS", group__gender: "M" },
            { name: "ì§€ë¯¼", group__name: "BTS", group__gender: "M" },
            { name: "ë·”", group__name: "BTS", group__gender: "M" },
            { name: "ì¹´ë¦¬ë‚˜", group__name: "aespa", group__gender: "F" },
            { name: "ìœˆí„°", group__name: "aespa", group__gender: "F" },
            { name: "ì§€ì ¤", group__name: "aespa", group__gender: "F" },
            { name: "ë‹ë‹", group__name: "aespa", group__gender: "F" },
            { name: "ë¯¼ì§€", group__name: "NewJeans", group__gender: "F" },
            { name: "í•˜ë‹ˆ", group__name: "NewJeans", group__gender: "F" },
            { name: "ë‹¤ë‹ˆì—˜", group__name: "NewJeans", group__gender: "F" },
            { name: "í•´ë¦°", group__name: "NewJeans", group__gender: "F" },
            { name: "í˜œì¸", group__name: "NewJeans", group__gender: "F" },
            { name: "ë§ˆí¬", group__name: "NCT DREAM", group__gender: "M" },
            { name: "ëŸ°ì¥”", group__name: "NCT DREAM", group__gender: "M" },
            { name: "ì œë…¸", group__name: "NCT DREAM", group__gender: "M" },
            { name: "í•´ì°¬", group__name: "NCT DREAM", group__gender: "M" },
            { name: "ì¬ë¯¼", group__name: "NCT DREAM", group__gender: "M" },
            { name: "ì²œëŸ¬", group__name: "NCT DREAM", group__gender: "M" },
            { name: "ì§€ì„±", group__name: "NCT DREAM", group__gender: "M" }
        ]
    };

    // ê²€ìƒ‰ í•„í„°ë§
    const filteredMembers = mockData.members.filter(member => {
        const nameMatch = member.name.toLowerCase().includes(query.toLowerCase()) || 
                        member.group__name.toLowerCase().includes(query.toLowerCase());
        
        if (currentFilter === 'all') return nameMatch;
        if (currentFilter === 'boy') return nameMatch && member.group__gender === 'M';
        if (currentFilter === 'girl') return nameMatch && member.group__gender === 'F';
        return nameMatch;
    });

    displaySearchResults(filteredMembers, container);
}

// ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
function displaySearchResults(members, container) {
    if (!container) return;
    
    container.innerHTML = "";

    const groups = {};
    members.forEach(member => {
        const groupName = member.group__name;
        if (!groups[groupName]) {
            groups[groupName] = {
                gender: member.group__gender,
                members: []
            };
        }
        groups[groupName].members.push(member);
    });

    Object.entries(groups).forEach(([groupName, info]) => {
        addGroupCard(groupName, info.gender, info.members, container);
    });
}

// ê·¸ë£¹ ì¹´ë“œ ì¶”ê°€
function addGroupCard(name, gender, members, container) {
    const groupCard = document.createElement("div");
    groupCard.className = "group-card";
    const typeClass = gender === "M" ? "boy-group" : "girl-group";

    groupCard.innerHTML = `
        <div class="group-header">
            <div class="group-name">${name}</div>
            <div class="group-type ${typeClass}">
                ${gender === "M" ? "ë³´ì´ê·¸ë£¹" : "ê±¸ê·¸ë£¹"}
            </div>
        </div>
        <div class="members-grid">
            ${members.map(member => {
                const memberKey = `${name}-${member.name}`;
                const isSelected = selectedMember === memberKey;
                return `
                    <button type="button" class="member-toggle ${isSelected ? 'selected' : ''}"
                            data-group="${name}" data-member="${member.name}">
                        ${member.name}
                    </button>
                `;
            }).join('')}
        </div>
    `;
    container.appendChild(groupCard);
}

// í•„í„° ë²„íŠ¼ í´ë¦­ ì²˜ë¦¬
function handleFilterClick(e) {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    currentFilter = e.target.dataset.filter;
    
    // ê²€ìƒ‰ ì¬ì‹¤í–‰
    const searchInput = document.getElementById("idolSearch");
    if (searchInput && searchInput.value.trim()) {
        searchInput.dispatchEvent(new Event("input"));
    }
}

// ë©¤ë²„ ì•¡ì…˜ ì²˜ë¦¬ (ì„ íƒ/í•´ì œ, ì œê±°)
function handleMemberActions(e) {
    // ë©¤ë²„ ì„ íƒ/í•´ì œ
    if (e.target.classList.contains('member-toggle')) {
        const group = e.target.dataset.group;
        const member = e.target.dataset.member;
        const key = `${group}-${member}`;

        // ê¸°ì¡´ ì„ íƒ í•´ì œ
        document.querySelectorAll('.member-toggle').forEach(btn => {
            btn.classList.remove('selected');
        });

        // ìƒˆë¡œìš´ ì„ íƒ
        if (selectedMember === key) {
            // ê°™ì€ ë©¤ë²„ë¥¼ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ì„ íƒ í•´ì œ
            selectedMember = null;
            isSelectionLocked = false;
        } else {
            // ë‹¤ë¥¸ ë©¤ë²„ ì„ íƒ
            selectedMember = key;
            isSelectionLocked = true; // ë©¤ë²„ ì„ íƒ ì‹œ ê³ ì •
            e.target.classList.add('selected');
        }

        updateSelectedDisplay();
        updateSelectionUI();
    }

    // ì„ íƒëœ ë©¤ë²„ ì œê±°
    if (e.target.classList.contains('remove-btn')) {
        selectedMember = null;
        isSelectionLocked = false;
        updateSelectedDisplay();
        updateSelectionUI();
        updateMemberButtons();
    }
}

// ì„ íƒ UI ì—…ë°ì´íŠ¸ (ê²€ìƒ‰ì°½ê³¼ í•„í„° ìˆ¨ê¸°ê¸°/ë³´ì´ê¸°)
function updateSelectionUI() {
    const searchSection = document.getElementById('idolSearch');
    const filterSection = document.querySelector('.filter-buttons');
    const groupsContainer = document.getElementById('groupsContainer');
    const searchNotice = document.getElementById('searchNotice');

    if (isSelectionLocked && selectedMember) {
        // ì„ íƒì´ ê³ ì •ëœ ê²½ìš° - ê²€ìƒ‰ì°½ê³¼ í•„í„° ìˆ¨ê¸°ê¸°
        if (searchSection) {
            searchSection.style.display = 'none';
        }
        if (filterSection) {
            filterSection.style.display = 'none';
        }
        if (groupsContainer) {
            groupsContainer.style.display = 'none';
        }
        if (searchNotice) {
            searchNotice.style.display = 'none';
        }
    } else {
        // ì„ íƒì´ í•´ì œëœ ê²½ìš° - ê²€ìƒ‰ì°½ê³¼ í•„í„° ë³´ì´ê¸°
        if (searchSection) {
            searchSection.style.display = 'block';
        }
        if (filterSection) {
            filterSection.style.display = 'flex';
        }
        if (groupsContainer) {
            groupsContainer.style.display = 'block';
        }
        if (searchNotice) {
            searchNotice.style.display = 'block';
        }
    }
}

// ì„ íƒëœ ë©¤ë²„ í‘œì‹œ ì—…ë°ì´íŠ¸
function updateSelectedDisplay() {
    const count = document.getElementById('selectedCount');
    const container = document.getElementById('selectedMembers');
    const list = document.getElementById('selectedList');

    if (count) count.textContent = selectedMember ? '1' : '0';
    
    if (container) {
        if (!selectedMember) {
            container.style.display = 'none';
        } else {
            container.style.display = 'block';
            if (list) {
                const [group, member] = selectedMember.split('-');
               list.innerHTML = `
                    <div class="selected-item">
                        <span class="badge group-badge">${group}</span>
                        <span class="badge member-badge">${member}</span>
                        <button class="remove-btn">Ã—</button>
                    </div>
                `;
            }
        }
    }
}

// ë©¤ë²„ ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
function updateMemberButtons() {
    document.querySelectorAll('.member-toggle').forEach(btn => {
        const group = btn.dataset.group;
        const member = btn.dataset.member;
        const key = `${group}-${member}`;
        const isSelected = selectedMember === key;

        btn.classList.toggle('selected', isSelected);
    });
}

// ë©¤ë²„ ì„ íƒ ì´ˆê¸°í™” (í•„ìš”ì‹œ ì‚¬ìš©)
function resetMemberSelection() {
    selectedMember = null;
    isSelectionLocked = false;
    updateSelectedDisplay();
    updateSelectionUI();
    updateMemberButtons();
    
    // ê²€ìƒ‰ì°½ ì´ˆê¸°í™”
    const searchInput = document.getElementById("idolSearch");
    if (searchInput) {
        searchInput.value = '';
    }
}
</script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
{%endblock%}
</body>
</html>