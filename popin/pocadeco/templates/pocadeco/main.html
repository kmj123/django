{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>í¬ì¹´ê¾¸ë¯¸ê¸° - PO-PIN</title>
    <link
      rel="stylesheet"
      href="https://cdn-uicons.flaticon.com/uicons-regular-rounded/css/uicons-regular-rounded.css"
    />
    <link rel="stylesheet" type="text/css" href="{% static 'css/pocadeco/main.css' %}" />
</head>
<body>
    <header class="header">
        <nav class="nav">
            <div class="logo">PO-PIN</div>
            <ul class="nav-menu">
                <li><a href="#home">í™ˆ</a></li>
                <li><a href="#exchange">í¬ì¹´êµí™˜</a></li>
                <li><a href="#community">ì»¤ë®¤ë‹ˆí‹°</a></li>
                <li><a href="#decorate" class="active">í¬ì¹´ê¾¸ë¯¸ê¸°</a></li>
                <li><a href="#customer">ê³ ê°ì§€ì›</a></li>
            </ul>
            <div class="auth-buttons">
                <a href="#" class="btn btn-outline">ë¡œê·¸ì¸</a>
                <a href="#" class="btn btn-primary">íšŒì›ê°€ì…</a>
            </div>
        </nav>
    </header>

    <div class="container">
        <div class="main-content">
            <div class="page-header">
                <h1 class="page-title">í¬í† ì¹´ë“œ ê¾¸ë¯¸ê¸°</h1>
            </div>

            <div class="editor-layout">
                <div class="editor-main">
                    <div class="canvas-container">
                        <div class="canvas-area" id="canvasArea">
                            <div class="canvas-placeholder" id="placeholder">
                                <i>ğŸ“·</i>
                                <div>í¬í† ì¹´ë“œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                                <small>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</small>
                            </div>
                        </div>
                        <input type="file" id="fileInput" accept="image/*" />
                    </div>

                    <div class="action-buttons">
                        <button class="btn btn-secondary" onclick="resetEditor()">ì´ˆê¸°í™”</button>
                        <button class="btn btn-primary" onclick="saveDecoration()">ì €ì¥í•˜ê¸°</button>
                        <button class="btn btn-success" onclick="downloadImage()">ë‹¤ìš´ë¡œë“œ</button>
                    </div>

                    <div style="margin-top: 40px;">
                        <div class="gallery-header">
                            <h2>ë‚´ í¬ê¾¸ ê°¤ëŸ¬ë¦¬</h2>
                            <button class="add-photo-btn" onclick="addToGallery()">
                                <span>ğŸ“·</span> ì‚¬ì§„ ì¶”ê°€
                            </button>
                        </div>
                        <input type="file" id="galleryInput" accept="image/*" />
                        <div class="gallery-grid" id="myGallery">
                            <div class="gallery-item">
                                <img src="{% static 'images/pocadeco/hanni.jpg' %}" alt="New Jeans Hanni" />
                                <div class="gallery-info">
                                    <div class="gallery-title">New Jeans í•˜ë‹ˆ</div>
                                    <div class="gallery-date">2024-06-12</div>
                                </div>
                                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
                            </div>
                            <div class="gallery-item">
                                <img src="{% static 'images/pocadeco/yushi.jpg' %}" alt="NCT Wish Yushi" />
                                <div class="gallery-info">
                                    <div class="gallery-title">NCT Wish ìœ ìš°ì‹œ</div>
                                    <div class="gallery-date">2024-06-11</div>
                                </div>
                                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
                            </div>
                            <div class="gallery-item">
                                <img src="{% static 'images/pocadeco/wonbin.jpg' %}" alt="RIIZE Wonbin" />
                                <div class="gallery-info">
                                    <div class="gallery-title">RIIZE ì›ë¹ˆ</div>
                                    <div class="gallery-date">2024-06-10</div>
                                </div>
                                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="editor-sidebar">
                    <div class="tool-section">
                        <h3>âš™ï¸ ì¡°ì •</h3>
                        <div class="slider-group">
                            <label>ë°ê¸°</label>
                            <input
                              type="range"
                              class="slider"
                              min="0"
                              max="200"
                              value="100"
                              data-filter="brightness"
                            />
                        </div>
                        <div class="slider-group">
                            <label>ëŒ€ë¹„</label>
                            <input
                              type="range"
                              class="slider"
                              min="0"
                              max="200"
                              value="100"
                              data-filter="contrast"
                            />
                        </div>
                        <div class="slider-group">
                            <label>ì±„ë„</label>
                            <input
                              type="range"
                              class="slider"
                              min="0"
                              max="200"
                              value="100"
                              data-filter="saturation"
                            />
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>ğŸ–¼ï¸ í”„ë ˆì„</h3>
                        <div class="frame-grid">
                            <div class="frame-option" data-frame="circle">
                                <div class="frame-preview circle"></div>
                            </div>
                            <div class="frame-option" data-frame="vintage">
                                <div class="frame-preview vintage"></div>
                            </div>
                            <div class="frame-option" data-frame="polaroid">
                                <div class="frame-preview polaroid"></div>
                            </div>
                            <div class="frame-option" data-frame="ornate">
                                <div class="frame-preview ornate"></div>
                            </div>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>ğŸ“ í…ìŠ¤íŠ¸ ì…ë ¥</h3>
                        <div class="text-input-group">
                            <input type="text" id="textInput" placeholder="í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" />
                        </div>
                        <div class="text-input-group" style="margin-top: 10px;">
                            <label for="fontSelect" style="display: none;">ê¸€ê¼´ ì„ íƒ</label>
                            <select id="fontSelect">
                                <option value="Nanum Gothic, sans-serif">ë‚˜ëˆ”ê³ ë”•</option>
                                <option value="Noto Sans KR, sans-serif">ë³¸ê³ ë”•</option>
                                <option value="Arial, sans-serif">Arial</option>
                                <option value="Verdana, sans-serif">Verdana</option>
                                <option value="Georgia, serif">Georgia</option>
                                <option value="Times New Roman, serif">Times New Roman</option>
                            </select>
                        </div>
                        <div class="add-text-button-container">
                            <button class="btn btn-primary" id="addTextBtn">í…ìŠ¤íŠ¸ ì¶”ê°€</button>
                        </div>
                    </div>

                    <div class="tool-section">
                        <h3>ğŸŒŸ ìŠ¤í‹°ì»¤</h3>
                        <div class="sticker-grid">
                            <div class="sticker-btn" data-sticker="ğŸ’–">ğŸ’–</div>
                            <div class="sticker-btn" data-sticker="â­">â­</div>
                            <div class="sticker-btn" data-sticker="âœ¨">âœ¨</div>
                            <div class="sticker-btn" data-sticker="ğŸ’­">ğŸ’­</div>
                            <div class="sticker-btn" data-sticker="ğŸ’¤">ğŸ’¤</div>
                            <div class="sticker-btn" data-sticker="ğŸ’¢">ğŸ’¢</div>
                            <div class="sticker-btn" data-sticker="ğŸ’«">ğŸ’«</div>
                            <div class="sticker-btn" data-sticker="ğŸ¹">ğŸ¹</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // 1. íŒŒì¼ ì—…ë¡œë“œ ì´ë²¤íŠ¸
    document.getElementById('fileInput').addEventListener('change', handleFileSelect);
    document.getElementById('galleryInput').addEventListener('change', handleGalleryAdd);

    // 2. í…ìŠ¤íŠ¸ ì¶”ê°€ ë²„íŠ¼
    document.getElementById('addTextBtn').addEventListener('click', addText);

    // 3. ìŠ¤í‹°ì»¤ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.sticker-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            addSticker(btn.dataset.sticker);
        });
    });

    // 4. í”„ë ˆì„ ì˜µì…˜ í´ë¦­ ì´ë²¤íŠ¸
    document.querySelectorAll('.frame-option').forEach(option => {
        option.addEventListener('click', function () {
            applyFrame(option.dataset.frame);
        });
    });

    // 5. ìŠ¬ë¼ì´ë” í•„í„° ì´ë²¤íŠ¸
    document.querySelectorAll('.slider').forEach(slider => {
        slider.addEventListener('input', () => {
            const type = slider.dataset.filter;
            const value = parseInt(slider.value);
            if (type === 'brightness') adjustBrightness(value);
            else if (type === 'contrast') adjustContrast(value);
            else if (type === 'saturation') adjustSaturation(value);
        });
    });

    // 6. canvas placeholder í´ë¦­ì‹œ íŒŒì¼ ì—…ë¡œë“œ íŠ¸ë¦¬ê±°
    const placeholder = document.getElementById('placeholder');
    if (placeholder) {
        placeholder.addEventListener('click', uploadPhoto);
    }

    // 7. ìº”ë²„ìŠ¤ ì˜ì—­ ë“œë˜ê·¸ ë°©ì§€ (ì˜ë„ì¹˜ ì•Šê²Œ í…ìŠ¤íŠ¸ ë“œë˜ê·¸ë˜ëŠ” ê±° ë§‰ê¸°)
    const canvas = document.getElementById('canvasArea');
    canvas.addEventListener('dragstart', e => e.preventDefault());
});

function uploadPhoto() {
    const canvas = document.getElementById('canvasArea');
    const existingPhoto = canvas.querySelector('.photo-preview'); // ì´ë¯¸ ì‚¬ì§„ì´ ìˆëŠ”ì§€ í™•ì¸
    if (existingPhoto) {
        // ì´ë¯¸ ì‚¬ì§„ì´ ìˆìœ¼ë©´ ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ì²¨ë¶€ ì°½ ëœ¨ì§€ ì•ŠìŒ)
        return;
    }
    document.getElementById('fileInput').click();
}

function handleFileSelect(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
            const canvas = document.getElementById('canvasArea');
            // ê¸°ì¡´ ì´ë¯¸ì§€ì™€ ìŠ¤í‹°ì»¤, í”„ë ˆì„, í…ìŠ¤íŠ¸ ì œê±°
            canvas.innerHTML = ''; 
            canvas.style.border = '3px dashed #ddd'; // í…Œë‘ë¦¬ ì´ˆê¸°í™”
            canvas.appendChild(Object.assign(document.createElement('img'), {
                src: e.target.result,
                className: 'photo-preview',
                id: 'uploadedPhoto'
            }));
            // í•„í„° ì´ˆê¸°í™”
            brightness = 100;
            contrast = 100;
            saturation = 100;
            updateFilters();
            // ìŠ¬ë¼ì´ë”ë„ ì´ˆê¸°í™”
            document.querySelectorAll('.slider').forEach(slider => slider.value = 100);
            // í”„ë ˆì„ ë²„íŠ¼ ì´ˆê¸°í™”
            document.querySelectorAll('.frame-option').forEach(option => option.classList.remove('active'));
            
            // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
            const textInput = document.getElementById('textInput');
            if (textInput) textInput.value = '';

            // ì‚¬ì§„ ì—…ë¡œë“œ í›„ ë§ˆìš°ìŠ¤ ì»¤ì„œ ìˆ¨ê¸°ê¸° (body ì „ì²´)
            document.body.style.cursor = 'none';
            // ìº”ë²„ìŠ¤ ì˜ì—­ì˜ ì»¤ì„œë„ ìˆ¨ê¹€
            canvas.style.cursor = 'none'; // ADDED THIS LINE
        };
        reader.readAsDataURL(file);
    }
}

function resetEditor() {
    const canvas = document.getElementById('canvasArea');
    canvas.innerHTML = `
        <div class="canvas-placeholder" id="placeholder">
            <i>ğŸ“·</i>
            <div>í¬í† ì¹´ë“œë¥¼ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
            <small>í´ë¦­í•˜ê±°ë‚˜ ë“œë˜ê·¸í•´ì„œ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</small>
        </div>`;
    canvas.style.border = '3px dashed #ddd'; // í…Œë‘ë¦¬ ì´ˆê¸°í™”
    canvas.style.cursor = 'pointer'; // RESET CANVAS CURSOR

    // í•„í„° ì´ˆê¸°í™”
    brightness = 100;
    contrast = 100;
    saturation = 100;
    // img ìš”ì†Œê°€ ì—†ìœ¼ë¯€ë¡œ updateFiltersëŠ” í˜¸ì¶œí•˜ì§€ ì•ŠìŒ

    // ìŠ¬ë¼ì´ë” ì´ˆê¸°í™”
    document.querySelectorAll('.slider').forEach(slider => slider.value = 100);
    // í”„ë ˆì„ ë²„íŠ¼ ì´ˆê¸°í™”
    document.querySelectorAll('.frame-option').forEach(option => option.classList.remove('active'));
    
    // í…ìŠ¤íŠ¸ ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    const textInput = document.getElementById('textInput');
    if (textInput) textInput.value = '';
    
    // ì—ë””í„° ì´ˆê¸°í™” ì‹œ ë§ˆìš°ìŠ¤ ì»¤ì„œ ë‹¤ì‹œ ë³´ì´ê²Œ í•¨ (body ì „ì²´)
    document.body.style.cursor = 'default';
}

function saveDecoration() {
    const canvasEl = document.getElementById('canvasArea');
    const img = canvasEl.querySelector('.photo-preview');
    if (!img) {
        alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”');
        return;
    }
    const title = prompt("í¬ê¾¸ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”:");
    if (!title) return; // ì‚¬ìš©ìê°€ ì·¨ì†Œí•˜ë©´ ì €ì¥í•˜ì§€ ì•ŠìŒ

    // html2canvas í˜¸ì¶œì— setTimeout ì¶”ê°€ (100ms ì§€ì—°)
    setTimeout(() => {
        html2canvas(canvasEl, {
            allowTaint: true, // í¬ë¡œìŠ¤ ì˜¤ë¦¬ì§„ ì´ë¯¸ì§€ ì²˜ë¦¬ í—ˆìš© (í•„ìš”ì‹œ)
            useCORS: true // CORS ë¬¸ì œ í•´ê²° (í•„ìš”ì‹œ)
        }).then(canvas => {
            const imgDataUrl = canvas.toDataURL('image/png'); // PNG ì´ë¯¸ì§€ ë°ì´í„° URL
            
            const gallery = document.getElementById('myGallery');
            const now = new Date().toISOString().split('T')[0];

            const item = document.createElement('div');
            item.className = 'gallery-item';
            item.innerHTML = `
                <img src="${imgDataUrl}" />
                <div class="gallery-info">
                    <div class="gallery-title" ondblclick="makeTitleEditable(this.parentElement)">${title}</div>
                    <div class="gallery-date">${now}</div>
                </div>
                <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
            `;
            gallery.prepend(item); // ê°¤ëŸ¬ë¦¬ ê°€ì¥ ì•ì— ì¶”ê°€
            document.body.style.cursor = 'none'; // ì €ì¥ í›„ ì»¤ì„œ ë‹¤ì‹œ ìˆ¨ê¹€
        }).catch(error => {
            console.error('ì´ë¯¸ì§€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë¯¸ì§€ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            document.body.style.cursor = 'none'; // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì»¤ì„œ ìˆ¨ê¹€
        });
    }, 100); // <-- ì—¬ê¸°ì— setTimeout ì¶”ê°€
}

function downloadImage() {
    const canvasEl = document.getElementById('canvasArea');
    const img = canvasEl.querySelector('.photo-preview');
    if (!img) {
        alert('ì´ë¯¸ì§€ë¥¼ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    // html2canvas í˜¸ì¶œì— setTimeout ì¶”ê°€ (100ms ì§€ì—°)
    setTimeout(() => {
        html2canvas(canvasEl, {
            allowTaint: true,
            useCORS: true
        }).then(canvas => {
            const link = document.createElement('a');
            link.href = canvas.toDataURL('image/png');
            link.download = 'poca_decorated.png';
            link.click();
            document.body.style.cursor = 'none'; // ë‹¤ìš´ë¡œë“œ í›„ ì»¤ì„œ ë‹¤ì‹œ ìˆ¨ê¹€
        }).catch(error => {
            console.error('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:', error);
            alert('ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì´ë¯¸ì§€ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            document.body.style.cursor = 'none'; // ì—ëŸ¬ ë°œìƒ ì‹œì—ë„ ì»¤ì„œ ìˆ¨ê¹€
        });
    }, 100); // <-- ì—¬ê¸°ì— setTimeout ì¶”ê°€
}

function addToGallery() {
    document.getElementById('galleryInput').click();
}

function handleGalleryAdd(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = function (e) {
        const gallery = document.getElementById('myGallery');
        const item = document.createElement('div');
        item.className = 'gallery-item';

        const now = new Date().toISOString().split('T')[0];

        item.innerHTML = `
            <img src="${e.target.result}" />
            <div class="gallery-info">
                <div class="gallery-title" ondblclick="makeTitleEditable(this.parentElement)">ì¶”ê°€ëœ ì´ë¯¸ì§€</div>
                <div class="gallery-date">${now}</div>
            </div>
            <button class="delete-btn" onclick="deleteGalleryItem(this)">Ã—</button>
        `;
        gallery.prepend(item);
    };
    reader.readAsDataURL(file);
}

function deleteGalleryItem(btn) {
    if (confirm("ì´ í¬í† ì¹´ë“œë¥¼ ê°¤ëŸ¬ë¦¬ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
        btn.parentElement.remove();
    }
}

function makeTitleEditable(element) {
    const title = element.querySelector('.gallery-title');
    title.setAttribute('contenteditable', true);
    title.focus();
    // Blur ì´ë²¤íŠ¸ ë°œìƒ ì‹œ contenteditable ì†ì„± ì œê±°
    title.onblur = () => {
        title.removeAttribute('contenteditable');
    };
    // Enter í‚¤ ëˆŒë €ì„ ë•Œë„ í¸ì§‘ ì¢…ë£Œ
    title.onkeydown = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault(); // ìƒˆ ì¤„ ë°©ì§€
            title.blur(); // í¸ì§‘ ì¢…ë£Œ
        }
    };
}

let brightness = 100;
let contrast = 100;
let saturation = 100;

function updateFilters() {
    const img = document.getElementById('uploadedPhoto');
    if (img) {
        img.style.filter = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
    }
}

function adjustBrightness(val) {
    brightness = val;
    updateFilters();
}

function adjustContrast(val) {
    contrast = val;
    updateFilters();
}

function adjustSaturation(val) {
    saturation = val;
    updateFilters();
}

function applyFrame(styleName) {
    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    // ê¸°ì¡´ í”„ë ˆì„ ì œê±°
    const existingFrame = canvas.querySelector('.frame-effect');
    if (existingFrame) existingFrame.remove();

    const frame = document.createElement('div');
    frame.className = `frame-effect ${styleName}`;
    canvas.appendChild(frame);

    // í™œì„±í™”ëœ í”„ë ˆì„ ë²„íŠ¼ í‘œì‹œ
    document.querySelectorAll('.frame-option').forEach(option => option.classList.remove('active'));
    event.currentTarget.classList.add('active');
}

let activeDraggable = null; // í˜„ì¬ ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ì¸ ìš”ì†Œë¥¼ ì¶”ì 

function makeDraggableAndResizable(element) {
    const canvas = document.getElementById('canvasArea');
    const resizeHandle = element.querySelector('.sticker-resize-handle');

    let isDragging = false;
    let isResizing = false;
    let offsetX = 0, offsetY = 0;
    let initialWidth, initialHeight, initialX, initialY, initialFontSize;

    element.onmousedown = function (e) {
        e.stopPropagation(); // ìº”ë²„ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
        activeDraggable = element; // í˜„ì¬ í™œì„± ìš”ì†Œ ì„¤ì •

        if (e.target === resizeHandle) {
            isResizing = true;
            initialX = e.clientX;
            initialY = e.clientY;
            initialWidth = element.offsetWidth;
            initialHeight = element.offsetHeight;
            initialFontSize = parseFloat(window.getComputedStyle(element).fontSize);
            element.style.cursor = 'nwse-resize';
            document.body.style.cursor = 'nwse-resize'; // ë°”ë”” ì»¤ì„œë„ ë³€ê²½
        } else {
            isDragging = true;
            offsetX = e.offsetX;
            offsetY = e.offsetY;
            element.style.cursor = 'grabbing';
            document.body.style.cursor = 'grabbing'; // ë°”ë”” ì»¤ì„œë„ ë³€ê²½
        }
        element.style.zIndex = 1000; // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ì¤‘ì—ëŠ” ìµœìƒìœ„ë¡œ
    };

    element.onmouseover = function() {
        if (!isDragging && !isResizing) {
            element.style.cursor = 'grab'; // ìŠ¤í‹°ì»¤/í…ìŠ¤íŠ¸ ìœ„ì— ìˆì„ ë•Œ
        }
    };
    element.onmouseout = function() {
        if (!isDragging && !isResizing) {
            element.style.cursor = ''; // ê¸°ë³¸ê°’ìœ¼ë¡œ ë˜ëŒë¦¼ (ìƒìœ„ ìš”ì†Œì˜ ì»¤ì„œ ìƒì†)
        }
    };
    document.onmousemove = function (e) {
        if (!activeDraggable) return; // í™œì„± ë“œë˜ê·¸ ìš”ì†Œê°€ ì—†ìœ¼ë©´ ë¦¬í„´

        const canvasRect = canvas.getBoundingClientRect();
        if (isDragging) {
            let newLeft = e.clientX - canvasRect.left - offsetX;
            let newTop = e.clientY - canvasRect.top - offsetY;

            // ìº”ë²„ìŠ¤ ì˜ì—­ì„ ë²—ì–´ë‚˜ì§€ ì•Šë„ë¡ ì œí•œ
            newLeft = Math.max(0, Math.min(newLeft, canvasRect.width - element.offsetWidth));
            newTop = Math.max(0, Math.min(newTop, canvasRect.height - element.offsetHeight));
            
            element.style.left = newLeft + 'px';
            element.style.top = newTop + 'px';
        } else if (isResizing) {
            const deltaX = e.clientX - initialX;
            const deltaY = e.clientY - initialY;

            let newFontSize;
            if (initialWidth > 0 && initialHeight > 0) {
                const ratioX = (initialWidth + deltaX) / initialWidth;
                const ratioY = (initialHeight + deltaY) / initialHeight;
                newFontSize = initialFontSize * Math.max(ratioX, ratioY);
            } else { 
                newFontSize = initialFontSize + Math.max(deltaX, deltaY);
            }

            // ìµœì†Œ í°íŠ¸ í¬ê¸° ì œí•œ
            newFontSize = Math.max(12, newFontSize); 
            // ìµœëŒ€ í°íŠ¸ í¬ê¸° ì œí•œ (ìº”ë²„ìŠ¤ í¬ê¸° ëŒ€ë¹„)
            const maxAllowedFontSize = Math.min(canvasRect.width, canvasRect.height) * 0.3; // ìº”ë²„ìŠ¤ ì§§ì€ ë³€ì˜ 30% ì •ë„ë¡œ ì œí•œ
            newFontSize = Math.min(newFontSize, maxAllowedFontSize);

            element.style.fontSize = newFontSize + 'px';
        }
    };

    document.onmouseup = function () {
        isDragging = false;
        isResizing = false;
        if (activeDraggable) {
            activeDraggable.style.zIndex = 10; // ë“œë˜ê·¸/ë¦¬ì‚¬ì´ì¦ˆ ëë‚˜ë©´ ê¸°ë³¸ z-indexë¡œ
            activeDraggable.style.cursor = 'grab'; // ì»¤ì„œ ì›ìƒ ë³µê·€
        }
        document.body.style.cursor = 'none'; // ë°”ë”” ì»¤ì„œ ë‹¤ì‹œ ìˆ¨ê¹€
        activeDraggable = null; // í™œì„± ìš”ì†Œ í•´ì œ
    };

    // ë”ë¸”í´ë¦­í•˜ë©´ ì‚­ì œ
    element.ondblclick = function (e) {
        e.stopPropagation(); // ìº”ë²„ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë°©ì§€
        if (confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            element.remove();
        }
    };
}

function addSticker(emoji) {
    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    const sticker = document.createElement('div');
    sticker.className = 'sticker-overlay';
    sticker.textContent = emoji;
    
    // ì´ˆê¸° ìœ„ì¹˜ (ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ê°€ê¹ê²Œ)
    const canvasRect = canvas.getBoundingClientRect();
    sticker.style.left = `${(canvasRect.width / 2) - 15}px`; // ìŠ¤í‹°ì»¤ í¬ê¸° ê³ ë ¤
    sticker.style.top = `${(canvasRect.height / 2) - 15}px`; // ìŠ¤í‹°ì»¤ í¬ê¸° ê³ ë ¤
    sticker.style.position = 'absolute';
    
    // í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ì¶”ê°€
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'sticker-resize-handle';
    sticker.appendChild(resizeHandle);

    canvas.appendChild(sticker);
    makeDraggableAndResizable(sticker); // ìŠ¤í‹°ì»¤ì— ë“œë˜ê·¸ ë° í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥ ë¶€ì—¬
    
    // ìŠ¤í‹°ì»¤ ì„ íƒ ì™„ë£Œ í›„ ë§ˆìš°ìŠ¤ ì»¤ì„œ ìˆ¨ê¸°ê¸°
    document.body.style.cursor = 'none';
}

function addText() {
    const textInput = document.getElementById('textInput');
    const textContent = textInput.value.trim();

    if (!textContent) {
        alert('ì…ë ¥í•  í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
    }

    const canvas = document.getElementById('canvasArea');
    const img = canvas.querySelector('.photo-preview');
    if (!img) {
        alert('ì‚¬ì§„ì„ ë¨¼ì € ì—…ë¡œë“œí•´ì£¼ì„¸ìš”!');
        return;
    }

    const textElement = document.createElement('div');
    textElement.className = 'text-overlay'; // ìŠ¤í‹°ì»¤ì™€ ë™ì¼í•œ ìŠ¤íƒ€ì¼ì„ ê³µìœ 
    textElement.textContent = textContent;
    
    // ê¸€ê¼´ ì ìš©
    const fontSelect = document.getElementById('fontSelect');
    const selectedFont = fontSelect.value;
    textElement.style.fontFamily = selectedFont;

    // ì´ˆê¸° ìœ„ì¹˜ (ìº”ë²„ìŠ¤ ì¤‘ì•™ì— ê°€ê¹ê²Œ)
    const canvasRect = canvas.getBoundingClientRect();
    textElement.style.left = `${(canvasRect.width / 2) - 50}px`; // í…ìŠ¤íŠ¸ í¬ê¸° ê³ ë ¤
    textElement.style.top = `${(canvasRect.height / 2) - 15}px`; // í…ìŠ¤íŠ¸ í¬ê¸° ê³ ë ¤
    textElement.style.position = 'absolute';
    textElement.style.color = 'black'; // ê¸°ë³¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒ
    
    // í¬ê¸° ì¡°ì ˆ í•¸ë“¤ ì¶”ê°€
    const resizeHandle = document.createElement('div');
    resizeHandle.className = 'sticker-resize-handle'; // ìŠ¤í‹°ì»¤ì™€ ë™ì¼í•œ í•¸ë“¤ ì‚¬ìš©
    textElement.appendChild(resizeHandle);

    canvas.appendChild(textElement);
    makeDraggableAndResizable(textElement); // í…ìŠ¤íŠ¸ì— ë“œë˜ê·¸ ë° í¬ê¸° ì¡°ì ˆ ê¸°ëŠ¥ ë¶€ì—¬

    textInput.value = ''; // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
    document.body.style.cursor = 'none'; // í…ìŠ¤íŠ¸ ì¶”ê°€ í›„ ì»¤ì„œ ìˆ¨ê¸°ê¸°
}
function updateFilters() {
    const img = document.getElementById('uploadedPhoto');
    if (img) {
        const filterValue = `brightness(${brightness}%) contrast(${contrast}%) saturate(${saturation}%)`;
        img.style.filter = filterValue;
        img.style.webkitFilter = filterValue; // ì‚¬íŒŒë¦¬ í˜¸í™˜ìš©
        // setAttributeëŠ” ì œê±°: ê¸°ì¡´ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° ë•Œë¬¸ì— ë ˆì´ì•„ì›ƒ ê¹¨ì§
    }
}
</script>
<script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
</body>
</html>

